<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>PWA详解 | QLQ学习平台</title>
    <meta name="description" content="QLQ学习平台">
    <link rel="manifest" href="/public/blog/manifest.json">
    
    <link rel="preload" href="/public/blog/assets/css/0.styles.3ad33863.css" as="style"><link rel="preload" href="/public/blog/assets/js/app.793d18d6.js" as="script"><link rel="preload" href="/public/blog/assets/js/2.d1dd4e4d.js" as="script"><link rel="preload" href="/public/blog/assets/js/63.6ee35392.js" as="script"><link rel="preload" href="/public/blog/assets/js/3.1f730cd9.js" as="script"><link rel="prefetch" href="/public/blog/assets/js/10.7d4b1d4b.js"><link rel="prefetch" href="/public/blog/assets/js/11.c135c766.js"><link rel="prefetch" href="/public/blog/assets/js/12.17db24c5.js"><link rel="prefetch" href="/public/blog/assets/js/13.6e07cbcf.js"><link rel="prefetch" href="/public/blog/assets/js/14.ea2a0d07.js"><link rel="prefetch" href="/public/blog/assets/js/15.a6a7563b.js"><link rel="prefetch" href="/public/blog/assets/js/16.956a9122.js"><link rel="prefetch" href="/public/blog/assets/js/17.06ff4bf4.js"><link rel="prefetch" href="/public/blog/assets/js/18.a604e43f.js"><link rel="prefetch" href="/public/blog/assets/js/19.43fdc1b1.js"><link rel="prefetch" href="/public/blog/assets/js/20.faad6d2d.js"><link rel="prefetch" href="/public/blog/assets/js/21.554b2f54.js"><link rel="prefetch" href="/public/blog/assets/js/22.961d3c7f.js"><link rel="prefetch" href="/public/blog/assets/js/23.98032a48.js"><link rel="prefetch" href="/public/blog/assets/js/24.735ada0c.js"><link rel="prefetch" href="/public/blog/assets/js/25.151f485c.js"><link rel="prefetch" href="/public/blog/assets/js/26.f3d12769.js"><link rel="prefetch" href="/public/blog/assets/js/27.d91bf872.js"><link rel="prefetch" href="/public/blog/assets/js/28.2a36a68f.js"><link rel="prefetch" href="/public/blog/assets/js/29.78b1b45d.js"><link rel="prefetch" href="/public/blog/assets/js/30.7481d4c5.js"><link rel="prefetch" href="/public/blog/assets/js/31.16e7c775.js"><link rel="prefetch" href="/public/blog/assets/js/32.75fed837.js"><link rel="prefetch" href="/public/blog/assets/js/33.cf2e0b8f.js"><link rel="prefetch" href="/public/blog/assets/js/34.4221897d.js"><link rel="prefetch" href="/public/blog/assets/js/35.97e4fc88.js"><link rel="prefetch" href="/public/blog/assets/js/36.137598cd.js"><link rel="prefetch" href="/public/blog/assets/js/37.9b12e9de.js"><link rel="prefetch" href="/public/blog/assets/js/38.8d385bd4.js"><link rel="prefetch" href="/public/blog/assets/js/39.c2d2376a.js"><link rel="prefetch" href="/public/blog/assets/js/4.a6ed393e.js"><link rel="prefetch" href="/public/blog/assets/js/40.a2197e85.js"><link rel="prefetch" href="/public/blog/assets/js/41.6e6eb90b.js"><link rel="prefetch" href="/public/blog/assets/js/42.ba8fc1fa.js"><link rel="prefetch" href="/public/blog/assets/js/43.561011ab.js"><link rel="prefetch" href="/public/blog/assets/js/44.0e624559.js"><link rel="prefetch" href="/public/blog/assets/js/45.31eb2ed7.js"><link rel="prefetch" href="/public/blog/assets/js/46.33d8378f.js"><link rel="prefetch" href="/public/blog/assets/js/47.18b18711.js"><link rel="prefetch" href="/public/blog/assets/js/48.84db573a.js"><link rel="prefetch" href="/public/blog/assets/js/49.e007afae.js"><link rel="prefetch" href="/public/blog/assets/js/5.868620b4.js"><link rel="prefetch" href="/public/blog/assets/js/50.05e06075.js"><link rel="prefetch" href="/public/blog/assets/js/51.28689d1c.js"><link rel="prefetch" href="/public/blog/assets/js/52.84b0ef5c.js"><link rel="prefetch" href="/public/blog/assets/js/53.693b991f.js"><link rel="prefetch" href="/public/blog/assets/js/54.3ebbd2e5.js"><link rel="prefetch" href="/public/blog/assets/js/55.c466c411.js"><link rel="prefetch" href="/public/blog/assets/js/56.02fb13e9.js"><link rel="prefetch" href="/public/blog/assets/js/57.a0811a6e.js"><link rel="prefetch" href="/public/blog/assets/js/58.ef3c4301.js"><link rel="prefetch" href="/public/blog/assets/js/59.5ecba546.js"><link rel="prefetch" href="/public/blog/assets/js/6.8e0ec0a1.js"><link rel="prefetch" href="/public/blog/assets/js/60.41e35580.js"><link rel="prefetch" href="/public/blog/assets/js/61.51154b06.js"><link rel="prefetch" href="/public/blog/assets/js/62.e557785e.js"><link rel="prefetch" href="/public/blog/assets/js/64.5bb83569.js"><link rel="prefetch" href="/public/blog/assets/js/65.b26f077a.js"><link rel="prefetch" href="/public/blog/assets/js/7.287519a5.js"><link rel="prefetch" href="/public/blog/assets/js/8.ad4df861.js"><link rel="prefetch" href="/public/blog/assets/js/9.ef0461e8.js">
    <link rel="stylesheet" href="/public/blog/assets/css/0.styles.3ad33863.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/public/blog/" class="home-link router-link-active"><!----> <span class="site-name">QLQ学习平台</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/public/blog/js/regexp.html" class="nav-link">javaScript</a></div><div class="nav-item"><a href="/public/blog/css/bfc.html" class="nav-link">css</a></div><div class="nav-item"><a href="/public/blog/webpack/base-config.html" class="nav-link">webpack</a></div><div class="nav-item"><a href="/public/blog/node/nodemon.html" class="nav-link">node</a></div><div class="nav-item"><a href="/public/blog/fragment/angular.html" class="nav-link">js框架</a></div><div class="nav-item"><a href="/public/blog/pwa/PWA.html" class="nav-link router-link-exact-active router-link-active">pwa</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/public/blog/js/regexp.html" class="nav-link">javaScript</a></div><div class="nav-item"><a href="/public/blog/css/bfc.html" class="nav-link">css</a></div><div class="nav-item"><a href="/public/blog/webpack/base-config.html" class="nav-link">webpack</a></div><div class="nav-item"><a href="/public/blog/node/nodemon.html" class="nav-link">node</a></div><div class="nav-item"><a href="/public/blog/fragment/angular.html" class="nav-link">js框架</a></div><div class="nav-item"><a href="/public/blog/pwa/PWA.html" class="nav-link router-link-exact-active router-link-active">pwa</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>pwa</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/public/blog/pwa/PWA.html" class="active sidebar-link">PWA详解</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/public/blog/pwa/PWA.html#介绍" class="sidebar-link">介绍</a></li><li class="sidebar-sub-header"><a href="/public/blog/pwa/PWA.html#fetch" class="sidebar-link">Fetch</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/public/blog/pwa/PWA.html#基本用法" class="sidebar-link">基本用法</a></li></ul></li><li class="sidebar-sub-header"><a href="/public/blog/pwa/PWA.html#cachestorage" class="sidebar-link">CacheStorage</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/public/blog/pwa/PWA.html#cachestorage常用方法介绍" class="sidebar-link">CacheStorage常用方法介绍</a></li></ul></li><li class="sidebar-sub-header"><a href="/public/blog/pwa/PWA.html#service-worker" class="sidebar-link">service worker</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/public/blog/pwa/PWA.html#生命周期" class="sidebar-link">生命周期</a></li><li class="sidebar-sub-header"><a href="/public/blog/pwa/PWA.html#结合代码理解service-worker生命周期" class="sidebar-link">结合代码理解service worker生命周期</a></li><li class="sidebar-sub-header"><a href="/public/blog/pwa/PWA.html#更新service-worker" class="sidebar-link">更新service worker</a></li><li class="sidebar-sub-header"><a href="/public/blog/pwa/PWA.html#waituntil延长生命周期" class="sidebar-link">waitUntil延长生命周期</a></li><li class="sidebar-sub-header"><a href="/public/blog/pwa/PWA.html#生命周期常见应用" class="sidebar-link">生命周期常见应用</a></li><li class="sidebar-sub-header"><a href="/public/blog/pwa/PWA.html#service-worker的作用域范围" class="sidebar-link">service worker的作用域范围?</a></li><li class="sidebar-sub-header"><a href="/public/blog/pwa/PWA.html#代码示例" class="sidebar-link">代码示例</a></li></ul></li><li class="sidebar-sub-header"><a href="/public/blog/pwa/PWA.html#离线开发的策略" class="sidebar-link">离线开发的策略</a></li><li class="sidebar-sub-header"><a href="/public/blog/pwa/PWA.html#syncmanager-后台同步" class="sidebar-link">syncManager 后台同步</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/public/blog/pwa/PWA.html#注册后台同步事件" class="sidebar-link">注册后台同步事件</a></li><li class="sidebar-sub-header"><a href="/public/blog/pwa/PWA.html#监听sync事件" class="sidebar-link">监听sync事件</a></li><li class="sidebar-sub-header"><a href="/public/blog/pwa/PWA.html#sync事件何时结束？" class="sidebar-link">sync事件何时结束？</a></li></ul></li><li class="sidebar-sub-header"><a href="/public/blog/pwa/PWA.html#postmessage" class="sidebar-link">postMessage</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/public/blog/pwa/PWA.html#_1-窗口向service-worker通信" class="sidebar-link">1. 窗口向service worker通信</a></li><li class="sidebar-sub-header"><a href="/public/blog/pwa/PWA.html#_2-service-worker向所有打开的窗口通信" class="sidebar-link">2. service worker向所有打开的窗口通信</a></li><li class="sidebar-sub-header"><a href="/public/blog/pwa/PWA.html#_3-service-worker向特定窗口通信" class="sidebar-link">3. service worker向特定窗口通信</a></li></ul></li><li class="sidebar-sub-header"><a href="/public/blog/pwa/PWA.html#messagechannel" class="sidebar-link">MessageChannel</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/public/blog/pwa/PWA.html#演示代码" class="sidebar-link">演示代码</a></li><li class="sidebar-sub-header"><a href="/public/blog/pwa/PWA.html#_4-窗口间的通信" class="sidebar-link">4. 窗口间的通信</a></li><li class="sidebar-sub-header"><a href="/public/blog/pwa/PWA.html#manifest-json" class="sidebar-link">manifest.json</a></li><li class="sidebar-sub-header"><a href="/public/blog/pwa/PWA.html#属性介绍" class="sidebar-link">属性介绍</a></li></ul></li><li class="sidebar-sub-header"><a href="/public/blog/pwa/PWA.html#消息推送" class="sidebar-link">消息推送</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="pwa-渐进式的web应用"><a href="#pwa-渐进式的web应用" class="header-anchor">#</a> PWA 渐进式的web应用</h1> <h2 id="介绍"><a href="#介绍" class="header-anchor">#</a> 介绍</h2> <p>我将带你快速熟悉一个pwa应用的基本使用</p> <p>本文中涉及到的内容：</p> <ul><li>fetch</li> <li>CacheStorage</li> <li>service worker</li> <li>SyncMannager</li> <li>postManager 与 messageChannal</li> <li>manifest.json</li> <li>消息推送</li></ul> <h2 id="fetch"><a href="#fetch" class="header-anchor">#</a> Fetch</h2> <p>Fetch 提供了许多与XMLHttpRequest相同的功能，为什么要在这里提及这个,因为在我们在service worker环境中是不能去使用XMLHttpRequest对象的，故而这是一个非常重要的api。</p> <p><strong>Fetch 的核心在于对 HTTP 接口的抽象，包括 Request，Response，Headers，Body这些接口</strong></p> <p>这里只是简单介绍</p> <h3 id="基本用法"><a href="#基本用法" class="header-anchor">#</a> 基本用法</h3> <div class="language-js extra-class"><pre class="language-js"><code>Promise<span class="token operator">&lt;</span>Response<span class="token operator">&gt;</span> <span class="token function">fetch</span><span class="token punctuation">(</span>input<span class="token punctuation">[</span><span class="token punctuation">,</span> init<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>参数介绍：</strong></p> <ul><li>input定义要获取的资源。可能值：</li></ul> <ol><li>string：资源的 URL。一些浏览器会接受 blob: 和 data: 作为 schemes.</li> <li>Request 对象。</li></ol> <ul><li>init 可选</li></ul> <ol><li>method: 请求方法，如 GET、POST。</li> <li>headers: 请求的头，可以为 Headers 的对象，或者形如{'Content-Type': 'image/jpeg'}。</li> <li>body: 请求体。可能为 Blob、BufferSource、FormData、URLSearchParams 或者 USVString 对象。GET 或 HEAD 无请求体。</li> <li>mode: 请求的模式，如 cors、 no-cors 或者 same-origin。</li> <li>credentials: 请求的 credentials，如 omit、same-origin 或者 include。为了在当前域名内自动发送 cookie ， 必须提供这个选项， 从 Chrome 50 开始， 这个属性也可以接受 FederatedCredential 实例或是一个 PasswordCredential 实例。</li> <li>...</li></ol> <h2 id="cachestorage"><a href="#cachestorage" class="header-anchor">#</a> CacheStorage</h2> <p>这是一个可以缓存浏览器缓存的接口，离线应用的核心就靠他了</p> <h3 id="cachestorage常用方法介绍"><a href="#cachestorage常用方法介绍" class="header-anchor">#</a> CacheStorage常用方法介绍</h3> <table><thead><tr><th>name</th> <th>描述</th></tr></thead> <tbody><tr><td>Cache.match(request, options)</td> <td>该方法会检查是否存在该request的缓存，返回 Promise对象，resolve的结果是跟 Cache 对象匹配的第一个已经缓存的请求。</td></tr> <tr><td>Cache.matchAll(request, options)</td> <td>同上，不同的是resolve的结果是跟Cache对象匹配的所有请求组成的数组。</td></tr> <tr><td>Cache.add(request)</td> <td>抓取这个URL, 检索并把返回的response对象添加到给定的Cache对象.这在功能上等同于调用 fetch(), 然后使用 Cache.put() 将response添加到cache中.</td></tr> <tr><td>Cache.addAll(requests)</td> <td>抓取一个URL数组，检索并把返回的response对象添加到给定的Cache对象。</td></tr> <tr><td>Cache.put(request, response)</td> <td>同时抓取一个请求及其响应，并将其添加到给定的cache。</td></tr> <tr><td>Cache.delete(request, options)</td> <td>搜索key值为request的Cache 条目。如果找到，则删除该Cache 条目，并且返回一个resolve为true的Promise对象；如果未找到，则返回一个resolve为false的Promise对象。</td></tr> <tr><td>Cache.keys(request, options)</td> <td>返回一个Promise对象，resolve的结果是Cache对象key值组成的数组。</td></tr></tbody></table> <p><strong>options参数的解释：</strong></p> <ul><li><strong>ignoreSearch</strong>（Boolean）: 忽略url中的query部分（?后面的参数）默认值：false</li> <li><strong>ignoreMethod</strong>（Boolean）: 如果设置为 true在匹配时就不会验证 Request 对象的http 方法 (通常只允许是 GET 或 HEAD 。) 默认值：false</li> <li><strong>ignoreVary</strong>（Boolean）: 该值如果为 true 则匹配时不进行 VARY   部分的匹配。默认值：false</li> <li><strong>cacheName</strong>（DOMString）: 代表一个具体的要被搜索的缓存。注意该选项被 Cache.match()方法忽略。</li></ul> <h2 id="service-worker"><a href="#service-worker" class="header-anchor">#</a> service worker</h2> <p>这是我们要花时间最多的地方！</p> <h3 id="生命周期"><a href="#生命周期" class="header-anchor">#</a> 生命周期</h3> <ol><li>installing（正在安装）</li></ol> <p><strong>当你调用 navigator.serviceWorker.register 注册一个新的 service worker ，service worker 代码就会被下载、解析、进入installing阶段。若安装成功则进入installed,失败则进入redundant</strong></p> <ol start="2"><li>installed/waiting（已安装/等待中）</li></ol> <p><strong>installed 状态下的service worker会判断自己是否已经被注册过，如果是第一次注册将进入activating状态，如果发现自己被注册且处于activated状态，那么将进入waiting状态</strong></p> <ol start="3"><li>activating（激活中）</li></ol> <p><strong>此状态下的sw将进入activated（必将进入activated状态）</strong></p> <ol start="4"><li>activated（已激活）</li></ol> <p><strong>一旦 service worker 激活，它就准备好接管页面并监听功能性事件了（例如 fetch 事件）</strong></p> <ol start="5"><li>redundant（废弃）</li></ol> <p><strong>当sw注册失败或者被新的sw替换将进入此状态（只有这两种情况会进入redundant）</strong></p> <h3 id="结合代码理解service-worker生命周期"><a href="#结合代码理解service-worker生命周期" class="header-anchor">#</a> 结合代码理解service worker生命周期</h3> <p>页面中的代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">&quot;serviceWorker&quot;</span> <span class="token keyword">in</span> navigator<span class="token punctuation">)</span><span class="token punctuation">{</span>
    window<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">&quot;./sw.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">registration</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
            <span class="token keyword">var</span> sw <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> state<span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>registration<span class="token punctuation">.</span>installing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                sw <span class="token operator">=</span> registration<span class="token punctuation">.</span>installing<span class="token punctuation">;</span>
                state <span class="token operator">=</span> <span class="token string">'installing'</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>registration<span class="token punctuation">.</span>waiting<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                sw <span class="token operator">=</span> registration<span class="token punctuation">.</span>waiting<span class="token punctuation">;</span>
                state <span class="token operator">=</span> <span class="token string">'installed'</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>registration<span class="token punctuation">.</span>active<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                sw <span class="token operator">=</span> registration<span class="token punctuation">.</span>active<span class="token punctuation">;</span>
                state <span class="token operator">=</span> <span class="token string">'activated'</span>
            <span class="token punctuation">}</span>
            state <span class="token operator">&amp;&amp;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">sw state is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>state<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>sw<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                sw<span class="token punctuation">.</span><span class="token function-variable function">onstatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">sw state is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>sw<span class="token punctuation">.</span>state<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'sw fail'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>sw.js：</p> <div class="language-js extra-class"><pre class="language-js"><code>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'install'</span><span class="token punctuation">,</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'install callback'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'activate'</span><span class="token punctuation">,</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'activate callback'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'fetch'</span><span class="token punctuation">,</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fetch callback'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>首次刷新页面</strong>控制台输出：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">install</span> callback
sw state is installing
sw state is installed
activate callback
sw state is activating
sw state is activated
</code></pre></div><p><strong>再次刷新页面</strong>控制台输出：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>sw state is activated
fetch callback
</code></pre></div><p><strong>install，与active事件仅仅执行一次，fetch在首次刷新也面试时是不请求的</strong></p> <h3 id="更新service-worker"><a href="#更新service-worker" class="header-anchor">#</a> 更新service worker</h3> <p>当更新sw时，刷新页面，此时：</p> <ol><li>新的sw的install回调触发，进入installing</li> <li>新的sw发现上一个sw还处于actived状态则进入waiting状态</li> <li>此时调用slkipwating方法或者关闭浏览器再次打开浏览器，会使旧的sw进入redundant，新的sw进入actived</li></ol> <p>代码此处可以自己尝试</p> <h3 id="waituntil延长生命周期"><a href="#waituntil延长生命周期" class="header-anchor">#</a> waitUntil延长生命周期</h3> <p>waitUntil函数传入promise作为参数，当promise执行完成才会接着往下走。</p> <h4 id="在install事件中调用该方法"><a href="#在install事件中调用该方法" class="header-anchor">#</a> 在install事件中调用该方法</h4> <p>1.加入成功的回调：</p> <div class="language-js extra-class"><pre class="language-js"><code>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'install'</span><span class="token punctuation">,</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'install 2s'</span><span class="token punctuation">)</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>控制台输出：</p> <div class="language-js extra-class"><pre class="language-js"><code>sw state is installing
install <span class="token number">2</span>s
sw state is installed
activate callback
sw state is activating
sw state is activated
</code></pre></div><ol start="2"><li>加入失败的回调：</li></ol> <div class="language-js extra-class"><pre class="language-js"><code>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'install'</span><span class="token punctuation">,</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'install 2s'</span><span class="token punctuation">)</span>
            <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>控制台输出：</p> <div class="language-js extra-class"><pre class="language-js"><code>sw state is installing
install <span class="token number">2</span>s
sw state is redundant
<span class="token function">Uncaught</span> <span class="token punctuation">(</span><span class="token keyword">in</span> promise<span class="token punctuation">)</span> <span class="token keyword">undefined</span>
</code></pre></div><p><strong>sw直接进入redundant阶段</strong></p> <h4 id="在activate事件中调用该方法"><a href="#在activate事件中调用该方法" class="header-anchor">#</a> 在activate事件中调用该方法</h4> <p>与install大致都一样，不同的是当你调用reject时，<strong>sw不会进入redundant阶段，而是最终还是进入actived阶段</strong>。</p> <h3 id="生命周期常见应用"><a href="#生命周期常见应用" class="header-anchor">#</a> 生命周期常见应用</h3> <ol><li>一般我们会在install中缓存请求，这是为了能够在下一次请求中使用到这些缓存。</li> <li>在active中我们应该清除旧的缓存。</li> <li>在fetch中我们便可以使用这些缓存，并且更新他们</li></ol> <h3 id="service-worker的作用域范围"><a href="#service-worker的作用域范围" class="header-anchor">#</a> service worker的作用域范围?</h3> <p>service worker只能捕获当前目录及其子目录下的请求！</p> <p>比如：<br>
当service worker在/pwa/sw.js下时那么只能捕获/pwa/*的请求，所以一般我们都应该将sw.js放置于/根目录下。</p> <h3 id="代码示例"><a href="#代码示例" class="header-anchor">#</a> 代码示例</h3> <p>如果你复制以下代码将在页面显示css代码</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token constant">CACHE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;gih-cache&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> <span class="token constant">CACHED_URLS</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;/pwa/test.css&quot;</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'install'</span><span class="token punctuation">,</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span>
        caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token constant">CACHE_NAME</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">cache</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> cache<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token constant">CACHED_URLS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'activate'</span><span class="token punctuation">,</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// event.waitUntil(</span>
    <span class="token comment">//     caches.keys().then(function(cacheNames) {</span>
    <span class="token comment">//         return Promise.all(</span>
    <span class="token comment">//             cacheNames.map(function(cacheName) {</span>
    <span class="token comment">//                 if (CACHE_NAME !== cacheName &amp;&amp; cacheName.startsWith(&quot;gih-cache&quot;)) {</span>
    <span class="token comment">//                     return caches.delete(cacheName);</span>
    <span class="token comment">//                 }</span>
    <span class="token comment">//             })</span>
    <span class="token comment">//         );</span>
    <span class="token comment">//     })</span>
    <span class="token comment">// );</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'fetch'</span><span class="token punctuation">,</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    event<span class="token punctuation">.</span><span class="token function">respondWith</span><span class="token punctuation">(</span>
        caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token constant">CACHE_NAME</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">cache</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> cache<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> fetchPromise <span class="token operator">=</span> <span class="token function">fetch</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">networkResponse</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>request<span class="token punctuation">,</span> networkResponse<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> networkResponse<span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> response <span class="token operator">||</span> fetchPromise<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre></div><h2 id="离线开发的策略"><a href="#离线开发的策略" class="header-anchor">#</a> 离线开发的策略</h2> <ol><li><strong>仅网络</strong></li> <li><strong>先网络后缓存</strong>：当我们希望用户看见内容一直是最新的，那么可以使用这种模式，在fetch中更新缓存数据</li> <li><strong>缓存后网络</strong>：当不需要用户看见最新的内容，我们可以先将缓存呈现给用户，在fetch中更新缓存，下一次用户刷新可以看见最新的缓存。（以上代码采取的就是这种）</li></ol> <h2 id="syncmanager-后台同步"><a href="#syncmanager-后台同步" class="header-anchor">#</a> syncManager 后台同步</h2> <p>在用户使用web app时，网页可能会被关闭，用户连接可能会断开，甚至服务器有时候也会故障。但是，<strong>只要用户设备上安装了浏览器</strong>，后台同步中的操作就不会消失，直到它成功完成为止。</p> <h3 id="注册后台同步事件"><a href="#注册后台同步事件" class="header-anchor">#</a> 注册后台同步事件</h3> <p>在页面中：</p> <div class="language-js extra-class"><pre class="language-js"><code>navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span>ready<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">registration</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     
    registration<span class="token punctuation">.</span>sync<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">'send-messages'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="监听sync事件"><a href="#监听sync事件" class="header-anchor">#</a> 监听sync事件</h3> <p>在sw.js中</p> <div class="language-js extra-class"><pre class="language-js"><code>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;sync&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">&quot;send-messages&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            <span class="token keyword">var</span> sent <span class="token operator">=</span> <span class="token function">sendMessages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
                
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="sync事件何时结束？"><a href="#sync事件何时结束？" class="header-anchor">#</a> sync事件何时结束？</h3> <p>当后台多次尝试不成功时，那么sync事件也会提供结束时的标识符<strong>event.lastChance</strong>。</p> <div class="language-js extra-class"><pre class="language-js"><code>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;sync&quot;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>tag <span class="token operator">==</span> <span class="token string">&quot;add-reservation&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span> 
            <span class="token function">addReservation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>lastChance<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
                    <span class="token keyword">return</span> <span class="token function">removeReservation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="postmessage"><a href="#postmessage" class="header-anchor">#</a> postMessage</h2> <p>当我们将逻辑代码放入service worker中时，我们就一定会有页面与service worker通信的需求，此时postMessage便是这么一个担任通信的角色。</p> <h3 id="_1-窗口向service-worker通信"><a href="#_1-窗口向service-worker通信" class="header-anchor">#</a> 1. 窗口向service worker通信</h3> <p>页面代码：</p> <div class="language-js extra-class"><pre class="language-js"><code>navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span>controller<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span> <span class="token punctuation">{</span>
    arrival<span class="token punctuation">:</span> <span class="token string">&quot;05/11/2022&quot;</span><span class="token punctuation">,</span> 
    nights<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> 
    guests<span class="token punctuation">:</span> <span class="token number">2</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>service worker代码：</p> <div class="language-js extra-class"><pre class="language-js"><code>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_2-service-worker向所有打开的窗口通信"><a href="#_2-service-worker向所有打开的窗口通信" class="header-anchor">#</a> 2. service worker向所有打开的窗口通信</h3> <p>页面代码：</p> <div class="language-js extra-class"><pre class="language-js"><code>navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>service worker代码：</p> <div class="language-js extra-class"><pre class="language-js"><code>self<span class="token punctuation">.</span>clients<span class="token punctuation">.</span><span class="token function">matchAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">clients</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    clients<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">client</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>client<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&quot;/my-account&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            client<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">&quot;Hi client: &quot;</span><span class="token operator">+</span>client<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_3-service-worker向特定窗口通信"><a href="#_3-service-worker向特定窗口通信" class="header-anchor">#</a> 3. service worker向特定窗口通信</h3> <p>service worker代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//当你可以获得某个客户端id时便可以向特定的客户端发送消息</span>
self<span class="token punctuation">.</span>clients<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;d2069ced-8f96-4d28&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">client</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    client<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">&quot;Hi window, you are currently &quot;</span> <span class="token operator">+</span>
                        client<span class="token punctuation">.</span>visibilityState<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="获得特定的客户端id"><a href="#获得特定的客户端id" class="header-anchor">#</a> 获得特定的客户端id</h4> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token comment">//通过clients对象获取客户端id</span>
self<span class="token punctuation">.</span>clients<span class="token punctuation">.</span><span class="token function">matchAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">clients</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    clients<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">client</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        self<span class="token punctuation">.</span>clients<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">client</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            client<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">&quot;Messaging using clients.matchAll()&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//通过event.sourse.id 获得·客户端id</span>
self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    self<span class="token punctuation">.</span>clients<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>source<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">client</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        client<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">&quot;Messaging using clients.get(event.source.id)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//简化写法</span>
self<span class="token punctuation">.</span>clients<span class="token punctuation">.</span><span class="token function">matchAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">clients</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    clients<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">client</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        client<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">&quot;Messaging using clients.matchAll()&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><h2 id="messagechannel"><a href="#messagechannel" class="header-anchor">#</a> MessageChannel</h2> <p>在介绍第四种通信方式（窗口间通信）时，我想先插入介绍一下MessageChannel这个对象，他是实现我们service worker与窗口间相互通信的一种有效的技术手段。</p> <h3 id="演示代码"><a href="#演示代码" class="header-anchor">#</a> 演示代码</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 窗口代码</span>
<span class="token keyword">var</span> msgChan <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
msgChan<span class="token punctuation">.</span>port1<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Message received in page:&quot;</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> msg <span class="token operator">=</span> <span class="token punctuation">{</span>action<span class="token punctuation">:</span> <span class="token string">&quot;triple&quot;</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">;</span> 
<span class="token comment">//这里可以是postMessage的第二个参数</span>
navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span>controller<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token punctuation">[</span>msgChan<span class="token punctuation">.</span>port2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// service worker代码 </span>
self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> data <span class="token operator">=</span> event<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
    <span class="token keyword">var</span> openPort <span class="token operator">=</span> event<span class="token punctuation">.</span>ports<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>action <span class="token operator">===</span> <span class="token string">&quot;triple&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        openPort<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>value<span class="token operator">*</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_4-窗口间的通信"><a href="#_4-窗口间的通信" class="header-anchor">#</a> 4. 窗口间的通信</h3> <p>窗口间通信方式有多种，你如localStorage这些都可以实现，这里还是应该思考如何使用service worker来进行通信，这里先不再赘述。</p> <h3 id="manifest-json"><a href="#manifest-json" class="header-anchor">#</a> manifest.json</h3> <p>当我们的web应用已经使用以上技术做到了一系列的离线优化后，我们可以考虑将我们的应用安装在本地。</p> <p>页面引入：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>manifest<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/manifest.json<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>manifest.json:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;short_name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Gotham Imperial&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Gotham Imperial Hotel&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Book your next stay, manage reservations, and explore Gotham&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;start_url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/my-account?utm_source=pwa&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;scope&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;display&quot;</span><span class="token operator">:</span> <span class="token string">&quot;fullscreen&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;icons&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
        <span class="token property">&quot;src&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/img/app-icon-192.png&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;image/png&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;sizes&quot;</span><span class="token operator">:</span> <span class="token string">&quot;192x192&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span> 
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;theme_color&quot;</span><span class="token operator">:</span> <span class="token string">&quot;#242424&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;background_color&quot;</span><span class="token operator">:</span> <span class="token string">&quot;#242424&quot;</span> 
<span class="token punctuation">}</span>
</code></pre></div><h3 id="属性介绍"><a href="#属性介绍" class="header-anchor">#</a> 属性介绍</h3> <ul><li><p><strong>name与/或short_name：</strong><br>
name 是应用的全名。当空间足够长时，就会使用这个字段作为显示名称，short_name 可以作为短 名的备选方案</p></li> <li><p><strong>start_url：</strong><br>
当用户点击图标时，打开的 URL。可以是根域名，也可以是内部页面。</p></li> <li><p><strong>icon：</strong><br>
包含了一个或多个对象的数组，对象属性：src(图标的绝对路径或者相对路径)、type(文件类型)和 sizes(图片的像素尺寸)。要触发Web应用安装横条，清单中至少要包含一个图标， 尺寸至少是 144像素×144像素。
由于每个设备都会根据设备分辨率，从这个数组中选择最佳的图标尺寸，因此建议至少 包含 192×192 的图标和 512×512 的图标，以覆盖大多数的设备和用途。</p></li> <li><p><strong>display：</strong></p></li></ul> <ol><li>browser——在浏览器中打开应用。</li> <li>standalone——打开应用时不显示浏览器栏(不显示浏览器界面，例如地址栏)。</li> <li>fullscreen——打开应用时不显示浏览器栏和设备栏(例如在安卓设备上，这意味着 同时隐藏浏览器界面和屏幕顶部的状态栏)。</li></ol> <ul><li><p><strong>description：</strong><br>
应用的描述。</p></li> <li><p><strong>orientation：</strong><br>
允许你强制指定某个屏幕方向。</p></li> <li><p><strong>theme_color</strong><br>
主题颜色可以让浏览器和设备调整 UI 以匹配你的网站(见图 9-5)。这个颜色的选择会 影响浏览器地址栏颜色、任务切换器中的应用颜色，甚至是设备状态栏的颜色。主题颜色也可以通过页面的meta标签进行设置(例如:</p><meta name="theme-color" content="#2196F3">)。如果页面带有 theme-color 的 meta 标签，则该设置会覆盖清单 中的 theme_color 设置。请注意，虽然 meta 标签可以让你设置或者覆盖单个页面的主 题颜色，但是清单文件中的 theme_color 设置是会影响整个应用的。<p></p></li> <li><p><strong>background_color</strong><br>
设置应用启动画面的颜色以及应用加载时的背景色。一旦加载后，页面中定义的任何背 景色(通过样式表或者内联 HTML 标签设置)都会覆盖这一设置;但是，通过将其设 置为与页面背景色相同的颜色，就可以实现从页面启动的瞬间到完全渲染之间的平滑过 渡。如果不设置这一颜色，页面就会从白色背景启动，随后被页面的背景色替换。</p></li> <li><p><strong>scope</strong><br>
如果我们设置了&quot;scope&quot;: &quot;/my-account/&quot;，当用户在这个作用域内跳转时(例 如 /my-acount/talater 或者 /my-account?sort=date)，会留在应用中。但是一旦用户点 击了这个范围外的链接(例如 /index.html 或者 https://pwabook.com)，页面就会在浏 览器中打开。</p></li> <li><p><strong>dir</strong><br>
显示 name、short_name 和 description参数文本的方向。默认情况下适配浏览器的语言 设置，但是也可以设置为以下值之一。<br>
• ltr——从左到右的语言，例如英语和葡萄牙语<br>
• rtl——从右到左的语言，例如希伯来语和阿拉伯语<br>
• auto——使用浏览器的语言设置</p></li> <li><p><strong>lang</strong><br>
指定 name、short_name 和 description 参数文本的主要语言。
可以和 dir 参数一起用来保证任何语言的文本正确显示，包括从右到左的语言。</p></li></ul> <p>...</p> <h2 id="消息推送"><a href="#消息推送" class="header-anchor">#</a> 消息推送</h2> <p>更新中</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/public/blog/assets/js/app.793d18d6.js" defer></script><script src="/public/blog/assets/js/2.d1dd4e4d.js" defer></script><script src="/public/blog/assets/js/63.6ee35392.js" defer></script><script src="/public/blog/assets/js/3.1f730cd9.js" defer></script>
  </body>
</html>
