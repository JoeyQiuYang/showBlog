(window.webpackJsonp=window.webpackJsonp||[]).push([[43],{261:function(e,t,s){"use strict";s.r(t);var a=s(3),n=Object(a.a)({},(function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("h1",{attrs:{id:"policies"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#policies"}},[e._v("#")]),e._v(" Policies")]),e._v(" "),s("blockquote",[s("p",[e._v("Stability: 1 - Experimental")])]),e._v(" "),s("p",[e._v("Node.js contains experimental support for creating policies on loading code.")]),e._v(" "),s("p",[e._v("Policies are a security feature intended to allow guarantees\nabout what code Node.js is able to load. The use of policies assumes\nsafe practices for the policy files such as ensuring that policy\nfiles cannot be overwritten by the Node.js application by using\nfile permissions.")]),e._v(" "),s("p",[e._v("A best practice would be to ensure that the policy manifest is read only for\nthe running Node.js application, and that the file cannot be changed\nby the running Node.js application in any way. A typical setup would be to\ncreate the policy file as a different user id than the one running Node.js\nand granting read permissions to the user id running Node.js.")]),e._v(" "),s("h2",{attrs:{id:"enabling"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#enabling"}},[e._v("#")]),e._v(" Enabling")]),e._v(" "),s("p",[e._v("The "),s("code",[e._v("--experimental-policy")]),e._v(" flag can be used to enable features for policies\nwhen loading modules.")]),e._v(" "),s("p",[e._v("Once this has been set, all modules must conform to a policy manifest file\npassed to the flag:")]),e._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[e._v("node --experimental-policy"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("policy.json app.js\n")])])]),s("p",[e._v("The policy manifest will be used to enforce constraints on code loaded by\nNode.js.")]),e._v(" "),s("p",[e._v("To mitigate tampering with policy files on disk, an integrity for\nthe policy file itself may be provided via "),s("code",[e._v("--policy-integrity")]),e._v(".\nThis allows running "),s("code",[e._v("node")]),e._v(" and asserting the policy file contents\neven if the file is changed on disk.")]),e._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[e._v("node --experimental-policy"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("policy.json --policy-integrity"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"sha384-SggXRQHwCG8g+DktYYzxkXRIkTiEYWBHqev0xnpCxYlqMBufKZHAHQM3/boDaI/0"')]),e._v(" app.js\n")])])]),s("h2",{attrs:{id:"features"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#features"}},[e._v("#")]),e._v(" Features")]),e._v(" "),s("h3",{attrs:{id:"error-behavior"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#error-behavior"}},[e._v("#")]),e._v(" Error Behavior")]),e._v(" "),s("p",[e._v('When a policy check fails, Node.js by default will throw an error.\nIt is possible to change the error behavior to one of a few possibilities\nby defining an "onerror" field in a policy manifest. The following values are\navailable to change the behavior:')]),e._v(" "),s("ul",[s("li",[s("code",[e._v('"exit"')]),e._v(": will exit the process immediately.\nNo cleanup code will be allowed to run.")]),e._v(" "),s("li",[s("code",[e._v('"log"')]),e._v(": will log the error at the site of the failure.")]),e._v(" "),s("li",[s("code",[e._v('"throw"')]),e._v(": will throw a JS error at the site of the failure. This is the\ndefault.")])]),e._v(" "),s("div",{staticClass:"language-json extra-class"},[s("pre",{pre:!0,attrs:{class:"language-json"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"onerror"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"log"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"resources"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"./app/checked.js"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n      "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"integrity"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"sha384-SggXRQHwCG8g+DktYYzxkXRIkTiEYWBHqev0xnpCxYlqMBufKZHAHQM3/boDaI/0"')]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])]),s("h3",{attrs:{id:"integrity-checks"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#integrity-checks"}},[e._v("#")]),e._v(" Integrity Checks")]),e._v(" "),s("p",[e._v("Policy files must use integrity checks with Subresource Integrity strings\ncompatible with the browser\n"),s("a",{attrs:{href:"https://www.w3.org/TR/SRI/#the-integrity-attribute",target:"_blank",rel:"noopener noreferrer"}},[e._v("integrity attribute"),s("OutboundLink")],1),e._v("\nassociated with absolute URLs.")]),e._v(" "),s("p",[e._v("When using "),s("code",[e._v("require()")]),e._v(" all resources involved in loading are checked for\nintegrity if a policy manifest has been specified. If a resource does not match\nthe integrity listed in the manifest, an error will be thrown.")]),e._v(" "),s("p",[e._v("An example policy file that would allow loading a file "),s("code",[e._v("checked.js")]),e._v(":")]),e._v(" "),s("div",{staticClass:"language-json extra-class"},[s("pre",{pre:!0,attrs:{class:"language-json"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"resources"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"./app/checked.js"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n      "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"integrity"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"sha384-SggXRQHwCG8g+DktYYzxkXRIkTiEYWBHqev0xnpCxYlqMBufKZHAHQM3/boDaI/0"')]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])]),s("p",[e._v("Each resource listed in the policy manifest can be of one the following\nformats to determine its location:")]),e._v(" "),s("ol",[s("li",[e._v("A "),s("a",{attrs:{href:"https://url.spec.whatwg.org/#relative-url-with-fragment-string",target:"_blank",rel:"noopener noreferrer"}},[e._v("relative url string"),s("OutboundLink")],1),e._v(" to a resource from the manifest such as "),s("code",[e._v("./resource.js")]),e._v(", "),s("code",[e._v("../resource.js")]),e._v(", or "),s("code",[e._v("/resource.js")]),e._v(".")]),e._v(" "),s("li",[e._v("A complete url string to a resource such as "),s("code",[e._v("file:///resource.js")]),e._v(".")])]),e._v(" "),s("p",[e._v("When loading resources the entire URL must match including search parameters\nand hash fragment. "),s("code",[e._v("./a.js?b")]),e._v(" will not be used when attempting to load\n"),s("code",[e._v("./a.js")]),e._v(" and vice versa.")]),e._v(" "),s("p",[e._v("To generate integrity strings, a script such as\n"),s("code",[e._v('printf "sha384-$(cat checked.js | openssl dgst -sha384 -binary | base64)"')]),e._v("\ncan be used.")]),e._v(" "),s("p",[e._v("Integrity can be specified as the boolean value "),s("code",[e._v("true")]),e._v(" to accept any\nbody for the resource which can be useful for local development. It is not\nrecommended in production since it would allow unexpected alteration of\nresources to be considered valid.")]),e._v(" "),s("h3",{attrs:{id:"dependency-redirection"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#dependency-redirection"}},[e._v("#")]),e._v(" Dependency Redirection")]),e._v(" "),s("p",[e._v("An application may need to ship patched versions of modules or to prevent\nmodules from allowing all modules access to all other modules. Redirection\ncan be used by intercepting attempts to load the modules wishing to be\nreplaced.")]),e._v(" "),s("div",{staticClass:"language-json extra-class"},[s("pre",{pre:!0,attrs:{class:"language-json"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"builtins"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"resources"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"./app/checked.js"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n      "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"dependencies"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n        "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"fs"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[e._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n        "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"os"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"./app/node_modules/alt-os"')]),e._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])]),s("p",[e._v("The dependencies are keyed by the requested string specifier and have values\nof either "),s("code",[e._v("true")]),e._v(" or a string pointing to a module that will be resolved.")]),e._v(" "),s("p",[e._v("The specifier string does not perform any searching and must match exactly\nwhat is provided to the "),s("code",[e._v("require()")]),e._v(". Therefore, multiple specifiers may be\nneeded in the policy if "),s("code",[e._v("require()")]),e._v(" uses multiple different strings to point\nto the same module (such as excluding the extension).")]),e._v(" "),s("p",[e._v("If the value of the redirection is "),s("code",[e._v("true")]),e._v(" the default searching algorithms will\nbe used to find the module.")]),e._v(" "),s("p",[e._v("If the value of the redirection is a string, it will be resolved relative to\nthe manifest and then immediately be used without searching.")]),e._v(" "),s("p",[e._v("Any specifier string that is "),s("code",[e._v("require()")]),e._v("ed and not listed in the dependencies\nwill result in an error according to the policy.")]),e._v(" "),s("p",[e._v("Redirection will not prevent access to APIs through means such as direct access\nto "),s("code",[e._v("require.cache")]),e._v(" and/or through "),s("code",[e._v("module.constructor")]),e._v(" which allow access to\nloading modules. Policy redirection only affect specifiers to "),s("code",[e._v("require()")]),e._v(".\nOther means such as to prevent undesired access to APIs through variables are\nnecessary to lock down that path of loading modules.")]),e._v(" "),s("p",[e._v("A boolean value of "),s("code",[e._v("true")]),e._v(" for the dependencies map can be specified to allow a\nmodule to load any specifier without redirection. This can be useful for local\ndevelopment and may have some valid usage in production, but should be used\nonly with care after auditing a module to ensure its behavior is valid.")]),e._v(" "),s("h4",{attrs:{id:"example-patched-dependency"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#example-patched-dependency"}},[e._v("#")]),e._v(" Example: Patched Dependency")]),e._v(" "),s("p",[e._v("Since a dependency can be redirected, you can provide attenuated or modified\nforms of dependencies as fits your application. For example, you could log\ndata about timing of function durations by wrapping the original:")]),e._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" original "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'fn'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\nmodule"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),s("span",{pre:!0,attrs:{class:"token function-variable function"}},[e._v("exports")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("function")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("fn")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("...")]),e._v("args")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("time")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("try")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("return")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("new")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("target "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("?")]),e._v("\n      Reflect"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("construct")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("original"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" args"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n      "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("Reflect")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("apply")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("original"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" args"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("finally")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("timeEnd")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])])])}),[],!1,null,null,null);t.default=n.exports}}]);