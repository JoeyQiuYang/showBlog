<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>VM (Executing JavaScript) | QLQ学习平台</title>
    <meta name="description" content="QLQ学习平台">
    <link rel="manifest" href="/public/blog/manifest.json">
    
    <link rel="preload" href="/public/blog/assets/css/0.styles.3ad33863.css" as="style"><link rel="preload" href="/public/blog/assets/js/app.e4ea57ce.js" as="script"><link rel="preload" href="/public/blog/assets/js/2.d1dd4e4d.js" as="script"><link rel="preload" href="/public/blog/assets/js/60.3e43121d.js" as="script"><link rel="preload" href="/public/blog/assets/js/3.1f730cd9.js" as="script"><link rel="prefetch" href="/public/blog/assets/js/10.7d4b1d4b.js"><link rel="prefetch" href="/public/blog/assets/js/11.b74ab56f.js"><link rel="prefetch" href="/public/blog/assets/js/12.5effa0dc.js"><link rel="prefetch" href="/public/blog/assets/js/13.6eb918e8.js"><link rel="prefetch" href="/public/blog/assets/js/14.0de95251.js"><link rel="prefetch" href="/public/blog/assets/js/15.fa3eaaf6.js"><link rel="prefetch" href="/public/blog/assets/js/16.fa5a1f3f.js"><link rel="prefetch" href="/public/blog/assets/js/17.65e33a7a.js"><link rel="prefetch" href="/public/blog/assets/js/18.a604e43f.js"><link rel="prefetch" href="/public/blog/assets/js/19.43fdc1b1.js"><link rel="prefetch" href="/public/blog/assets/js/20.c6e0b4b7.js"><link rel="prefetch" href="/public/blog/assets/js/21.81d73e54.js"><link rel="prefetch" href="/public/blog/assets/js/22.2da1489e.js"><link rel="prefetch" href="/public/blog/assets/js/23.98032a48.js"><link rel="prefetch" href="/public/blog/assets/js/24.bf1aeeb3.js"><link rel="prefetch" href="/public/blog/assets/js/25.ff0a5a9e.js"><link rel="prefetch" href="/public/blog/assets/js/26.9a69e70f.js"><link rel="prefetch" href="/public/blog/assets/js/27.78d71253.js"><link rel="prefetch" href="/public/blog/assets/js/28.05172e35.js"><link rel="prefetch" href="/public/blog/assets/js/29.836b5f2c.js"><link rel="prefetch" href="/public/blog/assets/js/30.7f2a0aa5.js"><link rel="prefetch" href="/public/blog/assets/js/31.16e7c775.js"><link rel="prefetch" href="/public/blog/assets/js/32.9d8aa648.js"><link rel="prefetch" href="/public/blog/assets/js/33.3ad73093.js"><link rel="prefetch" href="/public/blog/assets/js/34.a27e23cf.js"><link rel="prefetch" href="/public/blog/assets/js/35.34f0ba53.js"><link rel="prefetch" href="/public/blog/assets/js/36.993eb43f.js"><link rel="prefetch" href="/public/blog/assets/js/37.70ac44f6.js"><link rel="prefetch" href="/public/blog/assets/js/38.4b9e0ad1.js"><link rel="prefetch" href="/public/blog/assets/js/39.f8c33c98.js"><link rel="prefetch" href="/public/blog/assets/js/4.a6ed393e.js"><link rel="prefetch" href="/public/blog/assets/js/40.a2197e85.js"><link rel="prefetch" href="/public/blog/assets/js/41.467d6440.js"><link rel="prefetch" href="/public/blog/assets/js/42.ba8fc1fa.js"><link rel="prefetch" href="/public/blog/assets/js/43.b9d80aa8.js"><link rel="prefetch" href="/public/blog/assets/js/44.9b55cec1.js"><link rel="prefetch" href="/public/blog/assets/js/45.fbd44db5.js"><link rel="prefetch" href="/public/blog/assets/js/46.cff257a8.js"><link rel="prefetch" href="/public/blog/assets/js/47.3cd816de.js"><link rel="prefetch" href="/public/blog/assets/js/48.fdd057cb.js"><link rel="prefetch" href="/public/blog/assets/js/49.e007afae.js"><link rel="prefetch" href="/public/blog/assets/js/5.868620b4.js"><link rel="prefetch" href="/public/blog/assets/js/50.05e06075.js"><link rel="prefetch" href="/public/blog/assets/js/51.28689d1c.js"><link rel="prefetch" href="/public/blog/assets/js/52.84b0ef5c.js"><link rel="prefetch" href="/public/blog/assets/js/53.586cad0a.js"><link rel="prefetch" href="/public/blog/assets/js/54.2b8a703d.js"><link rel="prefetch" href="/public/blog/assets/js/55.c466c411.js"><link rel="prefetch" href="/public/blog/assets/js/56.882ab9d2.js"><link rel="prefetch" href="/public/blog/assets/js/57.edaca7e3.js"><link rel="prefetch" href="/public/blog/assets/js/58.c7ce4964.js"><link rel="prefetch" href="/public/blog/assets/js/59.02f33b29.js"><link rel="prefetch" href="/public/blog/assets/js/6.8e0ec0a1.js"><link rel="prefetch" href="/public/blog/assets/js/61.e73a45bf.js"><link rel="prefetch" href="/public/blog/assets/js/62.a1ea2161.js"><link rel="prefetch" href="/public/blog/assets/js/63.0a4a98df.js"><link rel="prefetch" href="/public/blog/assets/js/64.0422c733.js"><link rel="prefetch" href="/public/blog/assets/js/65.b26f077a.js"><link rel="prefetch" href="/public/blog/assets/js/7.287519a5.js"><link rel="prefetch" href="/public/blog/assets/js/8.5443f788.js"><link rel="prefetch" href="/public/blog/assets/js/9.ef0461e8.js">
    <link rel="stylesheet" href="/public/blog/assets/css/0.styles.3ad33863.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/public/blog/" class="home-link router-link-active"><!----> <span class="site-name">QLQ学习平台</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/public/blog/js/regexp.html" class="nav-link">javaScript</a></div><div class="nav-item"><a href="/public/blog/css/bfc.html" class="nav-link">css</a></div><div class="nav-item"><a href="/public/blog/webpack/base-config.html" class="nav-link">webpack</a></div><div class="nav-item"><a href="/public/blog/node/buffer.html" class="nav-link">node</a></div><div class="nav-item"><a href="/public/blog/fragment/angular.html" class="nav-link">js框架</a></div><div class="nav-item"><a href="/public/blog/pwa/PWA.html" class="nav-link">pwa</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/public/blog/js/regexp.html" class="nav-link">javaScript</a></div><div class="nav-item"><a href="/public/blog/css/bfc.html" class="nav-link">css</a></div><div class="nav-item"><a href="/public/blog/webpack/base-config.html" class="nav-link">webpack</a></div><div class="nav-item"><a href="/public/blog/node/buffer.html" class="nav-link">node</a></div><div class="nav-item"><a href="/public/blog/fragment/angular.html" class="nav-link">js框架</a></div><div class="nav-item"><a href="/public/blog/pwa/PWA.html" class="nav-link">pwa</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>node</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/public/blog/node/buffer.html" class="sidebar-link">Buffer</a></li><li><a href="/public/blog/node/stream.html" class="sidebar-link">Stream</a></li><li><a href="/public/blog/node/nodemon.html" class="sidebar-link">nodemon：高效的nodejs开发环境</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="vm-executing-javascript"><a href="#vm-executing-javascript" class="header-anchor">#</a> VM (Executing JavaScript)</h1> <blockquote><p>Stability: 2 - Stable</p></blockquote> <p>The <code>vm</code> module provides APIs for compiling and running code within V8 Virtual
Machine contexts. <strong>The <code>vm</code> module is not a security mechanism. Do
not use it to run untrusted code</strong>. The term &quot;sandbox&quot; is used throughout these
docs simply to refer to a separate context, and does not confer any security
guarantees.</p> <p>JavaScript code can be compiled and run immediately or
compiled, saved, and run later.</p> <p>A common use case is to run the code in a sandboxed environment.
The sandboxed code uses a different V8 Context, meaning that
it has a different global object than the rest of the code.</p> <p>One can provide the context by <a href="#vm_what_does_it_mean_to_contextify_an_object">&quot;contextifying&quot;</a> a sandbox
object. The sandboxed code treats any property in the sandbox like a
global variable. Any changes to global variables caused by the sandboxed
code are reflected in the sandbox object.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vm'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> sandbox <span class="token operator">=</span> <span class="token punctuation">{</span> x<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
vm<span class="token punctuation">.</span><span class="token function">createContext</span><span class="token punctuation">(</span>sandbox<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Contextify the sandbox.</span>

<span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token string">'x += 40; var y = 17;'</span><span class="token punctuation">;</span>
<span class="token comment">// `x` and `y` are global variables in the sandboxed environment.</span>
<span class="token comment">// Initially, x has the value 2 because that is the value of sandbox.x.</span>
vm<span class="token punctuation">.</span><span class="token function">runInContext</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> sandbox<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>sandbox<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 42</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>sandbox<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 17</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1; y is not defined.</span>
</code></pre></div><h2 id="class-vm-script"><a href="#class-vm-script" class="header-anchor">#</a> Class: vm.Script</h2> <p>Instances of the <code>vm.Script</code> class contain precompiled scripts that can be
executed in specific sandboxes (or &quot;contexts&quot;).</p> <h3 id="constructor-new-vm-script-code-options"><a href="#constructor-new-vm-script-code-options" class="header-anchor">#</a> Constructor: new vm.Script(code[, options])</h3> <ul><li><code>code</code> {string} The JavaScript code to compile.</li> <li><code>options</code> {Object|string}
<ul><li><code>filename</code> {string} Specifies the filename used in stack traces produced
by this script. <strong>Default:</strong> <code>'evalmachine.&lt;anonymous&gt;'</code>.</li> <li><code>lineOffset</code> {number} Specifies the line number offset that is displayed
in stack traces produced by this script. <strong>Default:</strong> <code>0</code>.</li> <li><code>columnOffset</code> {number} Specifies the column number offset that is displayed
in stack traces produced by this script. <strong>Default:</strong> <code>0</code>.</li> <li><code>cachedData</code> {Buffer|TypedArray|DataView} Provides an optional <code>Buffer</code> or
<code>TypedArray</code>, or <code>DataView</code> with V8's code cache data for the supplied
source. When supplied, the <code>cachedDataRejected</code> value will be set to
either <code>true</code> or <code>false</code> depending on acceptance of the data by V8.</li> <li><code>produceCachedData</code> {boolean} When <code>true</code> and no <code>cachedData</code> is present, V8
will attempt to produce code cache data for <code>code</code>. Upon success, a
<code>Buffer</code> with V8's code cache data will be produced and stored in the
<code>cachedData</code> property of the returned <code>vm.Script</code> instance.
The <code>cachedDataProduced</code> value will be set to either <code>true</code> or <code>false</code>
depending on whether code cache data is produced successfully.
This option is <strong>deprecated</strong> in favor of <code>script.createCachedData()</code>.
<strong>Default:</strong> <code>false</code>.</li> <li><code>importModuleDynamically</code> {Function} Called during evaluation of this module
when <code>import()</code> is called. If this option is not specified, calls to
<code>import()</code> will reject with <a href="/public/blog/node/errors.html#ERR_VM_DYNAMIC_IMPORT_CALLBACK_MISSING"><code>ERR_VM_DYNAMIC_IMPORT_CALLBACK_MISSING</code></a>.
This option is part of the experimental API for the <code>--experimental-modules</code>
flag, and should not be considered stable.
<ul><li><code>specifier</code> {string} specifier passed to <code>import()</code></li> <li><code>module</code> {vm.Module}</li> <li>Returns: {Module Namespace Object|vm.Module} Returning a <code>vm.Module</code> is
recommended in order to take advantage of error tracking, and to avoid
issues with namespaces that contain <code>then</code> function exports.</li></ul></li></ul></li></ul> <p>If <code>options</code> is a string, then it specifies the filename.</p> <p>Creating a new <code>vm.Script</code> object compiles <code>code</code> but does not run it. The
compiled <code>vm.Script</code> can be run later multiple times. The <code>code</code> is not bound to
any global object; rather, it is bound before each run, just for that run.</p> <h3 id="script-createcacheddata"><a href="#script-createcacheddata" class="header-anchor">#</a> script.createCachedData()</h3> <ul><li>Returns: {Buffer}</li></ul> <p>Creates a code cache that can be used with the Script constructor's
<code>cachedData</code> option. Returns a Buffer. This method may be called at any
time and any number of times.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> script <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">vm<span class="token punctuation">.</span>Script</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
function add(a, b) {
  return a + b;
}

const x = add(1, 2);
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> cacheWithoutX <span class="token operator">=</span> script<span class="token punctuation">.</span><span class="token function">createCachedData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

script<span class="token punctuation">.</span><span class="token function">runInThisContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> cacheWithX <span class="token operator">=</span> script<span class="token punctuation">.</span><span class="token function">createCachedData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="script-runincontext-contextifiedsandbox-options"><a href="#script-runincontext-contextifiedsandbox-options" class="header-anchor">#</a> script.runInContext(contextifiedSandbox[, options])</h3> <ul><li><code>contextifiedSandbox</code> {Object} A <a href="#vm_what_does_it_mean_to_contextify_an_object">contextified</a> object as returned by the
<code>vm.createContext()</code> method.</li> <li><code>options</code> {Object}
<ul><li><code>displayErrors</code> {boolean} When <code>true</code>, if an <a href="/public/blog/node/errors.html#errors_class_error"><code>Error</code></a> occurs
while compiling the <code>code</code>, the line of code causing the error is attached
to the stack trace. <strong>Default:</strong> <code>true</code>.</li> <li><code>timeout</code> {integer} Specifies the number of milliseconds to execute <code>code</code>
before terminating execution. If execution is terminated, an <a href="/public/blog/node/errors.html#errors_class_error"><code>Error</code></a>
will be thrown. This value must be a strictly positive integer.</li> <li><code>breakOnSigint</code> {boolean} If <code>true</code>, the execution will be terminated when
<code>SIGINT</code> (Ctrl+C) is received. Existing handlers for the
event that have been attached via <code>process.on('SIGINT')</code> will be disabled
during script execution, but will continue to work after that. If execution
is terminated, an <a href="/public/blog/node/errors.html#errors_class_error"><code>Error</code></a> will be thrown. <strong>Default:</strong> <code>false</code>.</li></ul></li> <li>Returns: {any} the result of the very last statement executed in the script.</li></ul> <p>Runs the compiled code contained by the <code>vm.Script</code> object within the given
<code>contextifiedSandbox</code> and returns the result. Running code does not have access
to local scope.</p> <p>The following example compiles code that increments a global variable, sets
the value of another global variable, then execute the code multiple times.
The globals are contained in the <code>sandbox</code> object.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> util <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'util'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vm'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> sandbox <span class="token operator">=</span> <span class="token punctuation">{</span>
  animal<span class="token punctuation">:</span> <span class="token string">'cat'</span><span class="token punctuation">,</span>
  count<span class="token punctuation">:</span> <span class="token number">2</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> script <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">vm<span class="token punctuation">.</span>Script</span><span class="token punctuation">(</span><span class="token string">'count += 1; name = &quot;kitty&quot;;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> context <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">createContext</span><span class="token punctuation">(</span>sandbox<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  script<span class="token punctuation">.</span><span class="token function">runInContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>util<span class="token punctuation">.</span><span class="token function">inspect</span><span class="token punctuation">(</span>sandbox<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// { animal: 'cat', count: 12, name: 'kitty' }</span>
</code></pre></div><p>Using the <code>timeout</code> or <code>breakOnSigint</code> options will result in new event loops
and corresponding threads being started, which have a non-zero performance
overhead.</p> <h3 id="script-runinnewcontext-sandbox-options"><a href="#script-runinnewcontext-sandbox-options" class="header-anchor">#</a> script.runInNewContext([sandbox[, options]])</h3> <ul><li><code>sandbox</code> {Object} An object that will be <a href="#vm_what_does_it_mean_to_contextify_an_object">contextified</a>. If <code>undefined</code>, a
new object will be created.</li> <li><code>options</code> {Object}
<ul><li><code>displayErrors</code> {boolean} When <code>true</code>, if an <a href="/public/blog/node/errors.html#errors_class_error"><code>Error</code></a> occurs
while compiling the <code>code</code>, the line of code causing the error is attached
to the stack trace. <strong>Default:</strong> <code>true</code>.</li> <li><code>timeout</code> {integer} Specifies the number of milliseconds to execute <code>code</code>
before terminating execution. If execution is terminated, an <a href="/public/blog/node/errors.html#errors_class_error"><code>Error</code></a>
will be thrown. This value must be a strictly positive integer.</li> <li><code>breakOnSigint</code> {boolean} If <code>true</code>, the execution will be terminated when
<code>SIGINT</code> (Ctrl+C) is received. Existing handlers for the
event that have been attached via <code>process.on('SIGINT')</code> will be disabled
during script execution, but will continue to work after that. If execution
is terminated, an <a href="/public/blog/node/errors.html#errors_class_error"><code>Error</code></a> will be thrown. <strong>Default:</strong> <code>false</code>.</li> <li><code>contextName</code> {string} Human-readable name of the newly created context.
<strong>Default:</strong> <code>'VM Context i'</code>, where <code>i</code> is an ascending numerical index of
the created context.</li> <li><code>contextOrigin</code> {string} <a href="https://developer.mozilla.org/en-US/docs/Glossary/Origin" target="_blank" rel="noopener noreferrer">Origin<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> corresponding to the newly
created context for display purposes. The origin should be formatted like a
URL, but with only the scheme, host, and port (if necessary), like the
value of the <a href="/public/blog/node/url.html#url_url_origin"><code>url.origin</code></a> property of a <a href="/public/blog/node/url.html#url_class_url"><code>URL</code></a> object. Most notably,
this string should omit the trailing slash, as that denotes a path.
<strong>Default:</strong> <code>''</code>.</li> <li><code>contextCodeGeneration</code> {Object}
<ul><li><code>strings</code> {boolean} If set to false any calls to <code>eval</code> or function
constructors (<code>Function</code>, <code>GeneratorFunction</code>, etc) will throw an
<code>EvalError</code>. <strong>Default:</strong> <code>true</code>.</li> <li><code>wasm</code> {boolean} If set to false any attempt to compile a WebAssembly
module will throw a <code>WebAssembly.CompileError</code>. <strong>Default:</strong> <code>true</code>.</li></ul></li></ul></li> <li>Returns: {any} the result of the very last statement executed in the script.</li></ul> <p>First contextifies the given <code>sandbox</code>, runs the compiled code contained by
the <code>vm.Script</code> object within the created sandbox, and returns the result.
Running code does not have access to local scope.</p> <p>The following example compiles code that sets a global variable, then executes
the code multiple times in different contexts. The globals are set on and
contained within each individual <code>sandbox</code>.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> util <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'util'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vm'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> script <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">vm<span class="token punctuation">.</span>Script</span><span class="token punctuation">(</span><span class="token string">'globalVar = &quot;set&quot;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> sandboxes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
sandboxes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">sandbox</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  script<span class="token punctuation">.</span><span class="token function">runInNewContext</span><span class="token punctuation">(</span>sandbox<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>util<span class="token punctuation">.</span><span class="token function">inspect</span><span class="token punctuation">(</span>sandboxes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// [{ globalVar: 'set' }, { globalVar: 'set' }, { globalVar: 'set' }]</span>
</code></pre></div><h3 id="script-runinthiscontext-options"><a href="#script-runinthiscontext-options" class="header-anchor">#</a> script.runInThisContext([options])</h3> <ul><li><code>options</code> {Object}
<ul><li><code>displayErrors</code> {boolean} When <code>true</code>, if an <a href="/public/blog/node/errors.html#errors_class_error"><code>Error</code></a> occurs
while compiling the <code>code</code>, the line of code causing the error is attached
to the stack trace. <strong>Default:</strong> <code>true</code>.</li> <li><code>timeout</code> {integer} Specifies the number of milliseconds to execute <code>code</code>
before terminating execution. If execution is terminated, an <a href="/public/blog/node/errors.html#errors_class_error"><code>Error</code></a>
will be thrown. This value must be a strictly positive integer.</li> <li><code>breakOnSigint</code> {boolean} If <code>true</code>, the execution will be terminated when
<code>SIGINT</code> (Ctrl+C) is received. Existing handlers for the
event that have been attached via <code>process.on('SIGINT')</code> will be disabled
during script execution, but will continue to work after that. If execution
is terminated, an <a href="/public/blog/node/errors.html#errors_class_error"><code>Error</code></a> will be thrown. <strong>Default:</strong> <code>false</code>.</li></ul></li> <li>Returns: {any} the result of the very last statement executed in the script.</li></ul> <p>Runs the compiled code contained by the <code>vm.Script</code> within the context of the
current <code>global</code> object. Running code does not have access to local scope, but
<em>does</em> have access to the current <code>global</code> object.</p> <p>The following example compiles code that increments a <code>global</code> variable then
executes that code multiple times:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vm'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

global<span class="token punctuation">.</span>globalVar <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> script <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">vm<span class="token punctuation">.</span>Script</span><span class="token punctuation">(</span><span class="token string">'globalVar += 1'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> filename<span class="token punctuation">:</span> <span class="token string">'myfile.vm'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  script<span class="token punctuation">.</span><span class="token function">runInThisContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>globalVar<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 1000</span>
</code></pre></div><h2 id="class-vm-module"><a href="#class-vm-module" class="header-anchor">#</a> Class: vm.Module</h2> <blockquote><p>Stability: 1 - Experimental</p></blockquote> <p><em>This feature is only available with the <code>--experimental-vm-modules</code> command
flag enabled.</em></p> <p>The <code>vm.Module</code> class provides a low-level interface for using
ECMAScript modules in VM contexts. It is the counterpart of the <code>vm.Script</code>
class that closely mirrors <a href="https://www.ecma-international.org/ecma-262/#sec-abstract-module-records" target="_blank" rel="noopener noreferrer">Module Record<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>s as defined in the ECMAScript
specification.</p> <p>Unlike <code>vm.Script</code> however, every <code>vm.Module</code> object is bound to a context from
its creation. Operations on <code>vm.Module</code> objects are intrinsically asynchronous,
in contrast with the synchronous nature of <code>vm.Script</code> objects. With the help
of async functions, however, manipulating <code>vm.Module</code> objects is fairly
straightforward.</p> <p>Using a <code>vm.Module</code> object requires three distinct steps: creation/parsing,
linking, and evaluation. These three steps are illustrated in the following
example.</p> <p>This implementation lies at a lower level than the <a href="/public/blog/node/esm.html#esm_ecmascript_modules">ECMAScript Module
loader</a>. There is also currently no way to interact with the Loader, though
support is planned.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vm'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> contextifiedSandbox <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">createContext</span><span class="token punctuation">(</span><span class="token punctuation">{</span> secret<span class="token punctuation">:</span> <span class="token number">42</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Step 1</span>
  <span class="token comment">//</span>
  <span class="token comment">// Create a Module by constructing a new `vm.SourceTextModule` object. This</span>
  <span class="token comment">// parses the provided source text, throwing a `SyntaxError` if anything goes</span>
  <span class="token comment">// wrong. By default, a Module is created in the top context. But here, we</span>
  <span class="token comment">// specify `contextifiedSandbox` as the context this Module belongs to.</span>
  <span class="token comment">//</span>
  <span class="token comment">// Here, we attempt to obtain the default export from the module &quot;foo&quot;, and</span>
  <span class="token comment">// put it into local binding &quot;secret&quot;.</span>

  <span class="token keyword">const</span> bar <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">vm<span class="token punctuation">.</span>SourceTextModule</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    import s from 'foo';
    s;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span> context<span class="token punctuation">:</span> contextifiedSandbox <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Step 2</span>
  <span class="token comment">//</span>
  <span class="token comment">// &quot;Link&quot; the imported dependencies of this Module to it.</span>
  <span class="token comment">//</span>
  <span class="token comment">// The provided linking callback (the &quot;linker&quot;) accepts two arguments: the</span>
  <span class="token comment">// parent module (`bar` in this case) and the string that is the specifier of</span>
  <span class="token comment">// the imported module. The callback is expected to return a Module that</span>
  <span class="token comment">// corresponds to the provided specifier, with certain requirements documented</span>
  <span class="token comment">// in `module.link()`.</span>
  <span class="token comment">//</span>
  <span class="token comment">// If linking has not started for the returned Module, the same linker</span>
  <span class="token comment">// callback will be called on the returned Module.</span>
  <span class="token comment">//</span>
  <span class="token comment">// Even top-level Modules without dependencies must be explicitly linked. The</span>
  <span class="token comment">// callback provided would never be called, however.</span>
  <span class="token comment">//</span>
  <span class="token comment">// The link() method returns a Promise that will be resolved when all the</span>
  <span class="token comment">// Promises returned by the linker resolve.</span>
  <span class="token comment">//</span>
  <span class="token comment">// Note: This is a contrived example in that the linker function creates a new</span>
  <span class="token comment">// &quot;foo&quot; module every time it is called. In a full-fledged module system, a</span>
  <span class="token comment">// cache would probably be used to avoid duplicated modules.</span>

  <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">linker</span><span class="token punctuation">(</span><span class="token parameter">specifier<span class="token punctuation">,</span> referencingModule</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>specifier <span class="token operator">===</span> <span class="token string">'foo'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">vm<span class="token punctuation">.</span>SourceTextModule</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
        // The &quot;secret&quot; variable refers to the global variable we added to
        // &quot;contextifiedSandbox&quot; when creating the context.
        export default secret;
      </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span> context<span class="token punctuation">:</span> referencingModule<span class="token punctuation">.</span>context <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Using `contextifiedSandbox` instead of `referencingModule.context`</span>
      <span class="token comment">// here would work as well.</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Unable to resolve dependency: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>specifier<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">await</span> bar<span class="token punctuation">.</span><span class="token function">link</span><span class="token punctuation">(</span>linker<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Step 3</span>
  <span class="token comment">//</span>
  <span class="token comment">// Evaluate the Module. The evaluate() method returns a Promise with a single</span>
  <span class="token comment">// property &quot;result&quot; that contains the result of the very last statement</span>
  <span class="token comment">// executed in the Module. In the case of `bar`, it is `s;`, which refers to</span>
  <span class="token comment">// the default export of the `foo` module, the `secret` we set in the</span>
  <span class="token comment">// beginning to 42.</span>

  <span class="token keyword">const</span> <span class="token punctuation">{</span> result <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> bar<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Prints 42.</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="module-dependencyspecifiers"><a href="#module-dependencyspecifiers" class="header-anchor">#</a> module.dependencySpecifiers</h3> <ul><li>{string[]}</li></ul> <p>The specifiers of all dependencies of this module. The returned array is frozen
to disallow any changes to it.</p> <p>Corresponds to the <code>[[RequestedModules]]</code> field of <a href="https://tc39.es/ecma262/#sec-cyclic-module-records" target="_blank" rel="noopener noreferrer">Cyclic Module Record<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>s in
the ECMAScript specification.</p> <h3 id="module-error"><a href="#module-error" class="header-anchor">#</a> module.error</h3> <ul><li>{any}</li></ul> <p>If the <code>module.status</code> is <code>'errored'</code>, this property contains the exception
thrown by the module during evaluation. If the status is anything else,
accessing this property will result in a thrown exception.</p> <p>The value <code>undefined</code> cannot be used for cases where there is not a thrown
exception due to possible ambiguity with <code>throw undefined;</code>.</p> <p>Corresponds to the <code>[[EvaluationError]]</code> field of <a href="https://tc39.es/ecma262/#sec-cyclic-module-records" target="_blank" rel="noopener noreferrer">Cyclic Module Record<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>s
in the ECMAScript specification.</p> <h3 id="module-evaluate-options"><a href="#module-evaluate-options" class="header-anchor">#</a> module.evaluate([options])</h3> <ul><li><code>options</code> {Object}
<ul><li><code>timeout</code> {integer} Specifies the number of milliseconds to evaluate
before terminating execution. If execution is interrupted, an <a href="/public/blog/node/errors.html#errors_class_error"><code>Error</code></a>
will be thrown. This value must be a strictly positive integer.</li> <li><code>breakOnSigint</code> {boolean} If <code>true</code>, the execution will be terminated when
<code>SIGINT</code> (Ctrl+C) is received. Existing handlers for the event that have
been attached via <code>process.on('SIGINT')</code> will be disabled during script
execution, but will continue to work after that. If execution is
interrupted, an <a href="/public/blog/node/errors.html#errors_class_error"><code>Error</code></a> will be thrown. <strong>Default:</strong> <code>false</code>.</li></ul></li> <li>Returns: {Promise}</li></ul> <p>Evaluate the module.</p> <p>This must be called after the module has been linked; otherwise it will
throw an error. It could be called also when the module has already been
evaluated, in which case it will do one of the following two things:</p> <ul><li>return <code>undefined</code> if the initial evaluation ended in success (<code>module.status</code>
is <code>'evaluated'</code>)</li> <li>rethrow the same exception the initial evaluation threw if the initial
evaluation ended in an error (<code>module.status</code> is <code>'errored'</code>)</li></ul> <p>This method cannot be called while the module is being evaluated
(<code>module.status</code> is <code>'evaluating'</code>) to prevent infinite recursion.</p> <p>Corresponds to the <a href="https://tc39.es/ecma262/#sec-moduleevaluation" target="_blank" rel="noopener noreferrer">Evaluate() concrete method<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> field of <a href="https://tc39.es/ecma262/#sec-cyclic-module-records" target="_blank" rel="noopener noreferrer">Cyclic Module
Record<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>s in the ECMAScript specification.</p> <h3 id="module-link-linker"><a href="#module-link-linker" class="header-anchor">#</a> module.link(linker)</h3> <ul><li><code>linker</code> {Function}
<ul><li><p><code>specifier</code> {string} The specifier of the requested module:
</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> foo <span class="token keyword">from</span> <span class="token string">'foo'</span><span class="token punctuation">;</span>
<span class="token comment">//              ^^^^^ the module specifier</span>
</code></pre></div></li> <li><p><code>referencingModule</code> {vm.Module} The <code>Module</code> object <code>link()</code> is called on.</p></li> <li><p>Returns: {vm.Module|Promise}</p></li></ul></li> <li>Returns: {Promise}</li></ul> <p>Link module dependencies. This method must be called before evaluation, and
can only be called once per module.</p> <p>The function is expected to return a <code>Module</code> object or a <code>Promise</code> that
eventually resolves to a <code>Module</code> object. The returned <code>Module</code> must satisfy the
following two invariants:</p> <ul><li>It must belong to the same context as the parent <code>Module</code>.</li> <li>Its <code>status</code> must not be <code>'errored'</code>.</li></ul> <p>If the returned <code>Module</code>'s <code>status</code> is <code>'unlinked'</code>, this method will be
recursively called on the returned <code>Module</code> with the same provided <code>linker</code>
function.</p> <p><code>link()</code> returns a <code>Promise</code> that will either get resolved when all linking
instances resolve to a valid <code>Module</code>, or rejected if the linker function either
throws an exception or returns an invalid <code>Module</code>.</p> <p>The linker function roughly corresponds to the implementation-defined
<a href="https://tc39.es/ecma262/#sec-hostresolveimportedmodule" target="_blank" rel="noopener noreferrer">HostResolveImportedModule<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> abstract operation in the ECMAScript
specification, with a few key differences:</p> <ul><li>The linker function is allowed to be asynchronous while
<a href="https://tc39.es/ecma262/#sec-hostresolveimportedmodule" target="_blank" rel="noopener noreferrer">HostResolveImportedModule<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> is synchronous.</li></ul> <p>The actual <a href="https://tc39.es/ecma262/#sec-hostresolveimportedmodule" target="_blank" rel="noopener noreferrer">HostResolveImportedModule<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> implementation used during module
linking is one that returns the modules linked during linking. Since at
that point all modules would have been fully linked already, the
<a href="https://tc39.es/ecma262/#sec-hostresolveimportedmodule" target="_blank" rel="noopener noreferrer">HostResolveImportedModule<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> implementation is fully synchronous per
specification.</p> <p>Corresponds to the <a href="https://tc39.es/ecma262/#sec-moduledeclarationlinking" target="_blank" rel="noopener noreferrer">Link() concrete method<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> field of <a href="https://tc39.es/ecma262/#sec-cyclic-module-records" target="_blank" rel="noopener noreferrer">Cyclic Module
Record<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>s in the ECMAScript specification.</p> <h3 id="module-namespace"><a href="#module-namespace" class="header-anchor">#</a> module.namespace</h3> <ul><li>{Object}</li></ul> <p>The namespace object of the module. This is only available after linking
(<code>module.link()</code>) has completed.</p> <p>Corresponds to the <a href="https://tc39.es/ecma262/#sec-getmodulenamespace" target="_blank" rel="noopener noreferrer">GetModuleNamespace<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> abstract operation in the ECMAScript
specification.</p> <h3 id="module-status"><a href="#module-status" class="header-anchor">#</a> module.status</h3> <ul><li>{string}</li></ul> <p>The current status of the module. Will be one of:</p> <ul><li><p><code>'unlinked'</code>: <code>module.link()</code> has not yet been called.</p></li> <li><p><code>'linking'</code>: <code>module.link()</code> has been called, but not all Promises returned
by the linker function have been resolved yet.</p></li> <li><p><code>'linked'</code>: The module has been linked successfully, and all of its
dependencies are linked, but <code>module.evaluate()</code> has not yet been called.</p></li> <li><p><code>'evaluating'</code>: The module is being evaluated through a <code>module.evaluate()</code> on
itself or a parent module.</p></li> <li><p><code>'evaluated'</code>: The module has been successfully evaluated.</p></li> <li><p><code>'errored'</code>: The module has been evaluated, but an exception was thrown.</p></li></ul> <p>Other than <code>'errored'</code>, this status string corresponds to the specification's
<a href="https://tc39.es/ecma262/#sec-cyclic-module-records" target="_blank" rel="noopener noreferrer">Cyclic Module Record<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>'s <code>[[Status]]</code> field. <code>'errored'</code> corresponds to
<code>'evaluated'</code> in the specification, but with <code>[[EvaluationError]]</code> set to a
value that is not <code>undefined</code>.</p> <h3 id="module-identifier"><a href="#module-identifier" class="header-anchor">#</a> module.identifier</h3> <ul><li>{string}</li></ul> <p>The identifier of the current module, as set in the constructor.</p> <h2 id="class-vm-sourcetextmodule"><a href="#class-vm-sourcetextmodule" class="header-anchor">#</a> Class: vm.SourceTextModule</h2> <blockquote><p>Stability: 1 - Experimental</p></blockquote> <p><em>This feature is only available with the <code>--experimental-vm-modules</code> command
flag enabled.</em></p> <ul><li>Extends: {vm.Module}</li></ul> <p>The <code>vm.SourceTextModule</code> class provides the <a href="https://tc39.es/ecma262/#sec-source-text-module-records" target="_blank" rel="noopener noreferrer">Source Text Module Record<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> as
defined in the ECMAScript specification.</p> <h3 id="constructor-new-vm-sourcetextmodule-code-options"><a href="#constructor-new-vm-sourcetextmodule-code-options" class="header-anchor">#</a> Constructor: new vm.SourceTextModule(code[, options])</h3> <ul><li><code>code</code> {string} JavaScript Module code to parse</li> <li><code>options</code> <ul><li><code>identifier</code> {string} String used in stack traces.
<strong>Default:</strong> <code>'vm:module(i)'</code> where <code>i</code> is a context-specific ascending
index.</li> <li><code>context</code> {Object} The <a href="#vm_what_does_it_mean_to_contextify_an_object">contextified</a> object as returned by the
<code>vm.createContext()</code> method, to compile and evaluate this <code>Module</code> in.</li> <li><code>lineOffset</code> {integer} Specifies the line number offset that is displayed
in stack traces produced by this <code>Module</code>. <strong>Default:</strong> <code>0</code>.</li> <li><code>columnOffset</code> {integer} Specifies the column number offset that is
displayed in stack traces produced by this <code>Module</code>. <strong>Default:</strong> <code>0</code>.</li> <li><code>initializeImportMeta</code> {Function} Called during evaluation of this <code>Module</code>
to initialize the <code>import.meta</code>.
<ul><li><code>meta</code> {import.meta}</li> <li><code>module</code> {vm.SourceTextModule}</li></ul></li> <li><code>importModuleDynamically</code> {Function} Called during evaluation of this module
when <code>import()</code> is called. If this option is not specified, calls to
<code>import()</code> will reject with <a href="/public/blog/node/errors.html#ERR_VM_DYNAMIC_IMPORT_CALLBACK_MISSING"><code>ERR_VM_DYNAMIC_IMPORT_CALLBACK_MISSING</code></a>.
<ul><li><code>specifier</code> {string} specifier passed to <code>import()</code></li> <li><code>module</code> {vm.Module}</li> <li>Returns: {Module Namespace Object|vm.Module} Returning a <code>vm.Module</code> is
recommended in order to take advantage of error tracking, and to avoid
issues with namespaces that contain <code>then</code> function exports.</li></ul></li></ul></li></ul> <p>Creates a new <code>SourceTextModule</code> instance.</p> <p>Properties assigned to the <code>import.meta</code> object that are objects may
allow the module to access information outside the specified <code>context</code>. Use
<code>vm.runInContext()</code> to create objects in a specific context.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vm'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> contextifiedSandbox <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">createContext</span><span class="token punctuation">(</span><span class="token punctuation">{</span> secret<span class="token punctuation">:</span> <span class="token number">42</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> module <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">vm<span class="token punctuation">.</span>SourceTextModule</span><span class="token punctuation">(</span>
    <span class="token string">'Object.getPrototypeOf(import.meta.prop).secret = secret;'</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token function">initializeImportMeta</span><span class="token punctuation">(</span><span class="token parameter">meta</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Note: this object is created in the top context. As such,</span>
        <span class="token comment">// Object.getPrototypeOf(import.meta.prop) points to the</span>
        <span class="token comment">// Object.prototype in the top context rather than that in</span>
        <span class="token comment">// the sandbox.</span>
        meta<span class="token punctuation">.</span>prop <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Since module has no dependencies, the linker function will never be called.</span>
  <span class="token keyword">await</span> module<span class="token punctuation">.</span><span class="token function">link</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> module<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Now, Object.prototype.secret will be equal to 42.</span>
  <span class="token comment">//</span>
  <span class="token comment">// To fix this problem, replace</span>
  <span class="token comment">//     meta.prop = {};</span>
  <span class="token comment">// above with</span>
  <span class="token comment">//     meta.prop = vm.runInContext('{}', contextifiedSandbox);</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="class-vm-syntheticmodule"><a href="#class-vm-syntheticmodule" class="header-anchor">#</a> Class: vm.SyntheticModule</h2> <blockquote><p>Stability: 1 - Experimental</p></blockquote> <p><em>This feature is only available with the <code>--experimental-vm-modules</code> command
flag enabled.</em></p> <ul><li>Extends: {vm.Module}</li></ul> <p>The <code>vm.SyntheticModule</code> class provides the <a href="https://heycam.github.io/webidl/#synthetic-module-records" target="_blank" rel="noopener noreferrer">Synthetic Module Record<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> as
defined in the WebIDL specification. The purpose of synthetic modules is to
provide a generic interface for exposing non-JavaScript sources to ECMAScript
module graphs.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vm'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> source <span class="token operator">=</span> <span class="token string">'{ &quot;a&quot;: 1 }'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> module <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">vm<span class="token punctuation">.</span>SyntheticModule</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'default'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setExport</span><span class="token punctuation">(</span><span class="token string">'default'</span><span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Use `module` in linking...</span>
</code></pre></div><h3 id="constructor-new-vm-syntheticmodule-exportnames-evaluatecallback-options"><a href="#constructor-new-vm-syntheticmodule-exportnames-evaluatecallback-options" class="header-anchor">#</a> Constructor: new vm.SyntheticModule(exportNames, evaluateCallback[, options])</h3> <ul><li><code>exportNames</code> {string[]} Array of names that will be exported from the module.</li> <li><code>evaluateCallback</code> {Function} Called when the module is evaluated.</li> <li><code>options</code> <ul><li><code>identifier</code> {string} String used in stack traces.
<strong>Default:</strong> <code>'vm:module(i)'</code> where <code>i</code> is a context-specific ascending
index.</li> <li><code>context</code> {Object} The <a href="#vm_what_does_it_mean_to_contextify_an_object">contextified</a> object as returned by the
<code>vm.createContext()</code> method, to compile and evaluate this <code>Module</code> in.</li></ul></li></ul> <p>Creates a new <code>SyntheticModule</code> instance.</p> <p>Objects assigned to the exports of this instance may allow importers of
the module to access information outside the specified <code>context</code>. Use
<code>vm.runInContext()</code> to create objects in a specific context.</p> <h3 id="syntheticmodule-setexport-name-value"><a href="#syntheticmodule-setexport-name-value" class="header-anchor">#</a> syntheticModule.setExport(name, value)</h3> <ul><li><code>name</code> {string} Name of the export to set.</li> <li><code>value</code> {any} The value to set the export to.</li></ul> <p>This method is used after the module is linked to set the values of exports. If
it is called before the module is linked, an <a href="/public/blog/node/errors.html#ERR_VM_MODULE_STATUS"><code>ERR_VM_MODULE_STATUS</code></a> error
will be thrown.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vm'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> m <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">vm<span class="token punctuation">.</span>SyntheticModule</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'x'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    m<span class="token punctuation">.</span><span class="token function">setExport</span><span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">await</span> m<span class="token punctuation">.</span><span class="token function">link</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> m<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  assert<span class="token punctuation">.</span><span class="token function">strictEqual</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>namespace<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="vm-compilefunction-code-params-options"><a href="#vm-compilefunction-code-params-options" class="header-anchor">#</a> vm.compileFunction(code[, params[, options]])</h2> <ul><li><code>code</code> {string} The body of the function to compile.</li> <li><code>params</code> {string[]} An array of strings containing all parameters for the
function.</li> <li><code>options</code> {Object}
<ul><li><code>filename</code> {string} Specifies the filename used in stack traces produced
by this script. <strong>Default:</strong> <code>''</code>.</li> <li><code>lineOffset</code> {number} Specifies the line number offset that is displayed
in stack traces produced by this script. <strong>Default:</strong> <code>0</code>.</li> <li><code>columnOffset</code> {number} Specifies the column number offset that is displayed
in stack traces produced by this script. <strong>Default:</strong> <code>0</code>.</li> <li><code>cachedData</code> {Buffer|TypedArray|DataView} Provides an optional <code>Buffer</code> or
<code>TypedArray</code>, or <code>DataView</code> with V8's code cache data for the supplied
source.</li> <li><code>produceCachedData</code> {boolean} Specifies whether to produce new cache data.
<strong>Default:</strong> <code>false</code>.</li> <li><code>parsingContext</code> {Object} The <a href="#vm_what_does_it_mean_to_contextify_an_object">contextified</a> sandbox in which the said
function should be compiled in.</li> <li><code>contextExtensions</code> {Object[]} An array containing a collection of context
extensions (objects wrapping the current scope) to be applied while
compiling. <strong>Default:</strong> <code>[]</code>.</li></ul></li> <li>Returns: {Function}</li></ul> <p>Compiles the given code into the provided context/sandbox (if no context is
supplied, the current context is used), and returns it wrapped inside a
function with the given <code>params</code>.</p> <h2 id="vm-createcontext-sandbox-options"><a href="#vm-createcontext-sandbox-options" class="header-anchor">#</a> vm.createContext([sandbox[, options]])</h2> <ul><li><code>sandbox</code> {Object}</li> <li><code>options</code> {Object}
<ul><li><code>name</code> {string} Human-readable name of the newly created context.
<strong>Default:</strong> <code>'VM Context i'</code>, where <code>i</code> is an ascending numerical index of
the created context.</li> <li><code>origin</code> {string} <a href="https://developer.mozilla.org/en-US/docs/Glossary/Origin" target="_blank" rel="noopener noreferrer">Origin<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> corresponding to the newly created
context for display purposes. The origin should be formatted like a URL,
but with only the scheme, host, and port (if necessary), like the value of
the <a href="/public/blog/node/url.html#url_url_origin"><code>url.origin</code></a> property of a <a href="/public/blog/node/url.html#url_class_url"><code>URL</code></a> object. Most notably, this
string should omit the trailing slash, as that denotes a path.
<strong>Default:</strong> <code>''</code>.</li> <li><code>codeGeneration</code> {Object}
<ul><li><code>strings</code> {boolean} If set to false any calls to <code>eval</code> or function
constructors (<code>Function</code>, <code>GeneratorFunction</code>, etc) will throw an
<code>EvalError</code>. <strong>Default:</strong> <code>true</code>.</li> <li><code>wasm</code> {boolean} If set to false any attempt to compile a WebAssembly
module will throw a <code>WebAssembly.CompileError</code>. <strong>Default:</strong> <code>true</code>.</li></ul></li></ul></li> <li>Returns: {Object} contextified sandbox.</li></ul> <p>If given a <code>sandbox</code> object, the <code>vm.createContext()</code> method will <a href="#vm_what_does_it_mean_to_contextify_an_object">prepare
that sandbox</a> so that it can be used in calls to
<a href="#vm_vm_runincontext_code_contextifiedsandbox_options"><code>vm.runInContext()</code></a> or <a href="#vm_script_runincontext_contextifiedsandbox_options"><code>script.runInContext()</code></a>. Inside such scripts,
the <code>sandbox</code> object will be the global object, retaining all of its existing
properties but also having the built-in objects and functions any standard
<a href="https://es5.github.io/#x15.1" target="_blank" rel="noopener noreferrer">global object<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> has. Outside of scripts run by the vm module, global variables
will remain unchanged.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> util <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'util'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vm'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

global<span class="token punctuation">.</span>globalVar <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> sandbox <span class="token operator">=</span> <span class="token punctuation">{</span> globalVar<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
vm<span class="token punctuation">.</span><span class="token function">createContext</span><span class="token punctuation">(</span>sandbox<span class="token punctuation">)</span><span class="token punctuation">;</span>

vm<span class="token punctuation">.</span><span class="token function">runInContext</span><span class="token punctuation">(</span><span class="token string">'globalVar *= 2;'</span><span class="token punctuation">,</span> sandbox<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>util<span class="token punctuation">.</span><span class="token function">inspect</span><span class="token punctuation">(</span>sandbox<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { globalVar: 2 }</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>util<span class="token punctuation">.</span><span class="token function">inspect</span><span class="token punctuation">(</span>globalVar<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>
</code></pre></div><p>If <code>sandbox</code> is omitted (or passed explicitly as <code>undefined</code>), a new, empty
<a href="#vm_what_does_it_mean_to_contextify_an_object">contextified</a> sandbox object will be returned.</p> <p>The <code>vm.createContext()</code> method is primarily useful for creating a single
sandbox that can be used to run multiple scripts. For instance, if emulating a
web browser, the method can be used to create a single sandbox representing a
window's global object, then run all <code>&lt;script&gt;</code> tags together within the context
of that sandbox.</p> <p>The provided <code>name</code> and <code>origin</code> of the context are made visible through the
Inspector API.</p> <h2 id="vm-iscontext-sandbox"><a href="#vm-iscontext-sandbox" class="header-anchor">#</a> vm.isContext(sandbox)</h2> <ul><li><code>sandbox</code> {Object}</li> <li>Returns: {boolean}</li></ul> <p>Returns <code>true</code> if the given <code>sandbox</code> object has been <a href="#vm_what_does_it_mean_to_contextify_an_object">contextified</a> using
<a href="#vm_vm_createcontext_sandbox_options"><code>vm.createContext()</code></a>.</p> <h2 id="vm-runincontext-code-contextifiedsandbox-options"><a href="#vm-runincontext-code-contextifiedsandbox-options" class="header-anchor">#</a> vm.runInContext(code, contextifiedSandbox[, options])</h2> <ul><li><code>code</code> {string} The JavaScript code to compile and run.</li> <li><code>contextifiedSandbox</code> {Object} The <a href="#vm_what_does_it_mean_to_contextify_an_object">contextified</a> object that will be used
as the <code>global</code> when the <code>code</code> is compiled and run.</li> <li><code>options</code> {Object|string}
<ul><li><code>filename</code> {string} Specifies the filename used in stack traces produced
by this script. <strong>Default:</strong> <code>'evalmachine.&lt;anonymous&gt;'</code>.</li> <li><code>lineOffset</code> {number} Specifies the line number offset that is displayed
in stack traces produced by this script. <strong>Default:</strong> <code>0</code>.</li> <li><code>columnOffset</code> {number} Specifies the column number offset that is displayed
in stack traces produced by this script. <strong>Default:</strong> <code>0</code>.</li> <li><code>displayErrors</code> {boolean} When <code>true</code>, if an <a href="/public/blog/node/errors.html#errors_class_error"><code>Error</code></a> occurs
while compiling the <code>code</code>, the line of code causing the error is attached
to the stack trace. <strong>Default:</strong> <code>true</code>.</li> <li><code>timeout</code> {integer} Specifies the number of milliseconds to execute <code>code</code>
before terminating execution. If execution is terminated, an <a href="/public/blog/node/errors.html#errors_class_error"><code>Error</code></a>
will be thrown. This value must be a strictly positive integer.</li> <li><code>breakOnSigint</code> {boolean} If <code>true</code>, the execution will be terminated when
<code>SIGINT</code> (Ctrl+C) is received. Existing handlers for the
event that have been attached via <code>process.on('SIGINT')</code> will be disabled
during script execution, but will continue to work after that. If execution
is terminated, an <a href="/public/blog/node/errors.html#errors_class_error"><code>Error</code></a> will be thrown. <strong>Default:</strong> <code>false</code>.</li> <li><code>cachedData</code> {Buffer|TypedArray|DataView} Provides an optional <code>Buffer</code> or
<code>TypedArray</code>, or <code>DataView</code> with V8's code cache data for the supplied
source. When supplied, the <code>cachedDataRejected</code> value will be set to
either <code>true</code> or <code>false</code> depending on acceptance of the data by V8.</li> <li><code>produceCachedData</code> {boolean} When <code>true</code> and no <code>cachedData</code> is present, V8
will attempt to produce code cache data for <code>code</code>. Upon success, a
<code>Buffer</code> with V8's code cache data will be produced and stored in the
<code>cachedData</code> property of the returned <code>vm.Script</code> instance.
The <code>cachedDataProduced</code> value will be set to either <code>true</code> or <code>false</code>
depending on whether code cache data is produced successfully.
This option is <strong>deprecated</strong> in favor of <code>script.createCachedData()</code>.
<strong>Default:</strong> <code>false</code>.</li> <li><code>importModuleDynamically</code> {Function} Called during evaluation of this module
when <code>import()</code> is called. If this option is not specified, calls to
<code>import()</code> will reject with <a href="/public/blog/node/errors.html#ERR_VM_DYNAMIC_IMPORT_CALLBACK_MISSING"><code>ERR_VM_DYNAMIC_IMPORT_CALLBACK_MISSING</code></a>.
This option is part of the experimental API for the <code>--experimental-modules</code>
flag, and should not be considered stable.
<ul><li><code>specifier</code> {string} specifier passed to <code>import()</code></li> <li><code>module</code> {vm.Module}</li> <li>Returns: {Module Namespace Object|vm.Module} Returning a <code>vm.Module</code> is
recommended in order to take advantage of error tracking, and to avoid
issues with namespaces that contain <code>then</code> function exports.</li></ul></li></ul></li> <li>Returns: {any} the result of the very last statement executed in the script.</li></ul> <p>The <code>vm.runInContext()</code> method compiles <code>code</code>, runs it within the context of
the <code>contextifiedSandbox</code>, then returns the result. Running code does not have
access to the local scope. The <code>contextifiedSandbox</code> object <em>must</em> have been
previously <a href="#vm_what_does_it_mean_to_contextify_an_object">contextified</a> using the <a href="#vm_vm_createcontext_sandbox_options"><code>vm.createContext()</code></a> method.</p> <p>If <code>options</code> is a string, then it specifies the filename.</p> <p>The following example compiles and executes different scripts using a single
<a href="#vm_what_does_it_mean_to_contextify_an_object">contextified</a> object:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> util <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'util'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vm'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> sandbox <span class="token operator">=</span> <span class="token punctuation">{</span> globalVar<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
vm<span class="token punctuation">.</span><span class="token function">createContext</span><span class="token punctuation">(</span>sandbox<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  vm<span class="token punctuation">.</span><span class="token function">runInContext</span><span class="token punctuation">(</span><span class="token string">'globalVar *= 2;'</span><span class="token punctuation">,</span> sandbox<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>util<span class="token punctuation">.</span><span class="token function">inspect</span><span class="token punctuation">(</span>sandbox<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// { globalVar: 1024 }</span>
</code></pre></div><h2 id="vm-runinnewcontext-code-sandbox-options"><a href="#vm-runinnewcontext-code-sandbox-options" class="header-anchor">#</a> vm.runInNewContext(code[, sandbox[, options]])</h2> <ul><li><code>code</code> {string} The JavaScript code to compile and run.</li> <li><code>sandbox</code> {Object} An object that will be <a href="#vm_what_does_it_mean_to_contextify_an_object">contextified</a>. If <code>undefined</code>, a
new object will be created.</li> <li><code>options</code> {Object|string}
<ul><li><code>filename</code> {string} Specifies the filename used in stack traces produced
by this script. <strong>Default:</strong> <code>'evalmachine.&lt;anonymous&gt;'</code>.</li> <li><code>lineOffset</code> {number} Specifies the line number offset that is displayed
in stack traces produced by this script. <strong>Default:</strong> <code>0</code>.</li> <li><code>columnOffset</code> {number} Specifies the column number offset that is displayed
in stack traces produced by this script. <strong>Default:</strong> <code>0</code>.</li> <li><code>displayErrors</code> {boolean} When <code>true</code>, if an <a href="/public/blog/node/errors.html#errors_class_error"><code>Error</code></a> occurs
while compiling the <code>code</code>, the line of code causing the error is attached
to the stack trace. <strong>Default:</strong> <code>true</code>.</li> <li><code>timeout</code> {integer} Specifies the number of milliseconds to execute <code>code</code>
before terminating execution. If execution is terminated, an <a href="/public/blog/node/errors.html#errors_class_error"><code>Error</code></a>
will be thrown. This value must be a strictly positive integer.</li> <li><code>breakOnSigint</code> {boolean} If <code>true</code>, the execution will be terminated when
<code>SIGINT</code> (Ctrl+C) is received. Existing handlers for the
event that have been attached via <code>process.on('SIGINT')</code> will be disabled
during script execution, but will continue to work after that. If execution
is terminated, an <a href="/public/blog/node/errors.html#errors_class_error"><code>Error</code></a> will be thrown. <strong>Default:</strong> <code>false</code>.</li> <li><code>contextName</code> {string} Human-readable name of the newly created context.
<strong>Default:</strong> <code>'VM Context i'</code>, where <code>i</code> is an ascending numerical index of
the created context.</li> <li><code>contextOrigin</code> {string} <a href="https://developer.mozilla.org/en-US/docs/Glossary/Origin" target="_blank" rel="noopener noreferrer">Origin<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> corresponding to the newly
created context for display purposes. The origin should be formatted like a
URL, but with only the scheme, host, and port (if necessary), like the
value of the <a href="/public/blog/node/url.html#url_url_origin"><code>url.origin</code></a> property of a <a href="/public/blog/node/url.html#url_class_url"><code>URL</code></a> object. Most notably,
this string should omit the trailing slash, as that denotes a path.
<strong>Default:</strong> <code>''</code>.</li> <li><code>contextCodeGeneration</code> {Object}
<ul><li><code>strings</code> {boolean} If set to false any calls to <code>eval</code> or function
constructors (<code>Function</code>, <code>GeneratorFunction</code>, etc) will throw an
<code>EvalError</code>. <strong>Default:</strong> <code>true</code>.</li> <li><code>wasm</code> {boolean} If set to false any attempt to compile a WebAssembly
module will throw a <code>WebAssembly.CompileError</code>. <strong>Default:</strong> <code>true</code>.</li></ul></li> <li><code>cachedData</code> {Buffer|TypedArray|DataView} Provides an optional <code>Buffer</code> or
<code>TypedArray</code>, or <code>DataView</code> with V8's code cache data for the supplied
source. When supplied, the <code>cachedDataRejected</code> value will be set to
either <code>true</code> or <code>false</code> depending on acceptance of the data by V8.</li> <li><code>produceCachedData</code> {boolean} When <code>true</code> and no <code>cachedData</code> is present, V8
will attempt to produce code cache data for <code>code</code>. Upon success, a
<code>Buffer</code> with V8's code cache data will be produced and stored in the
<code>cachedData</code> property of the returned <code>vm.Script</code> instance.
The <code>cachedDataProduced</code> value will be set to either <code>true</code> or <code>false</code>
depending on whether code cache data is produced successfully.
This option is <strong>deprecated</strong> in favor of <code>script.createCachedData()</code>.
<strong>Default:</strong> <code>false</code>.</li> <li><code>importModuleDynamically</code> {Function} Called during evaluation of this module
when <code>import()</code> is called. If this option is not specified, calls to
<code>import()</code> will reject with <a href="/public/blog/node/errors.html#ERR_VM_DYNAMIC_IMPORT_CALLBACK_MISSING"><code>ERR_VM_DYNAMIC_IMPORT_CALLBACK_MISSING</code></a>.
This option is part of the experimental API for the <code>--experimental-modules</code>
flag, and should not be considered stable.
<ul><li><code>specifier</code> {string} specifier passed to <code>import()</code></li> <li><code>module</code> {vm.Module}</li> <li>Returns: {Module Namespace Object|vm.Module} Returning a <code>vm.Module</code> is
recommended in order to take advantage of error tracking, and to avoid
issues with namespaces that contain <code>then</code> function exports.</li></ul></li></ul></li> <li>Returns: {any} the result of the very last statement executed in the script.</li></ul> <p>The <code>vm.runInNewContext()</code> first contextifies the given <code>sandbox</code> object (or
creates a new <code>sandbox</code> if passed as <code>undefined</code>), compiles the <code>code</code>, runs it
within the context of the created context, then returns the result. Running code
does not have access to the local scope.</p> <p>If <code>options</code> is a string, then it specifies the filename.</p> <p>The following example compiles and executes code that increments a global
variable and sets a new one. These globals are contained in the <code>sandbox</code>.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> util <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'util'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vm'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> sandbox <span class="token operator">=</span> <span class="token punctuation">{</span>
  animal<span class="token punctuation">:</span> <span class="token string">'cat'</span><span class="token punctuation">,</span>
  count<span class="token punctuation">:</span> <span class="token number">2</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

vm<span class="token punctuation">.</span><span class="token function">runInNewContext</span><span class="token punctuation">(</span><span class="token string">'count += 1; name = &quot;kitty&quot;'</span><span class="token punctuation">,</span> sandbox<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>util<span class="token punctuation">.</span><span class="token function">inspect</span><span class="token punctuation">(</span>sandbox<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// { animal: 'cat', count: 3, name: 'kitty' }</span>
</code></pre></div><h2 id="vm-runinthiscontext-code-options"><a href="#vm-runinthiscontext-code-options" class="header-anchor">#</a> vm.runInThisContext(code[, options])</h2> <ul><li><code>code</code> {string} The JavaScript code to compile and run.</li> <li><code>options</code> {Object|string}
<ul><li><code>filename</code> {string} Specifies the filename used in stack traces produced
by this script. <strong>Default:</strong> <code>'evalmachine.&lt;anonymous&gt;'</code>.</li> <li><code>lineOffset</code> {number} Specifies the line number offset that is displayed
in stack traces produced by this script. <strong>Default:</strong> <code>0</code>.</li> <li><code>columnOffset</code> {number} Specifies the column number offset that is displayed
in stack traces produced by this script. <strong>Default:</strong> <code>0</code>.</li> <li><code>displayErrors</code> {boolean} When <code>true</code>, if an <a href="/public/blog/node/errors.html#errors_class_error"><code>Error</code></a> occurs
while compiling the <code>code</code>, the line of code causing the error is attached
to the stack trace. <strong>Default:</strong> <code>true</code>.</li> <li><code>timeout</code> {integer} Specifies the number of milliseconds to execute <code>code</code>
before terminating execution. If execution is terminated, an <a href="/public/blog/node/errors.html#errors_class_error"><code>Error</code></a>
will be thrown. This value must be a strictly positive integer.</li> <li><code>breakOnSigint</code> {boolean} If <code>true</code>, the execution will be terminated when
<code>SIGINT</code> (Ctrl+C) is received. Existing handlers for the
event that have been attached via <code>process.on('SIGINT')</code> will be disabled
during script execution, but will continue to work after that. If execution
is terminated, an <a href="/public/blog/node/errors.html#errors_class_error"><code>Error</code></a> will be thrown. <strong>Default:</strong> <code>false</code>.</li> <li><code>cachedData</code> {Buffer|TypedArray|DataView} Provides an optional <code>Buffer</code> or
<code>TypedArray</code>, or <code>DataView</code> with V8's code cache data for the supplied
source. When supplied, the <code>cachedDataRejected</code> value will be set to
either <code>true</code> or <code>false</code> depending on acceptance of the data by V8.</li> <li><code>produceCachedData</code> {boolean} When <code>true</code> and no <code>cachedData</code> is present, V8
will attempt to produce code cache data for <code>code</code>. Upon success, a
<code>Buffer</code> with V8's code cache data will be produced and stored in the
<code>cachedData</code> property of the returned <code>vm.Script</code> instance.
The <code>cachedDataProduced</code> value will be set to either <code>true</code> or <code>false</code>
depending on whether code cache data is produced successfully.
This option is <strong>deprecated</strong> in favor of <code>script.createCachedData()</code>.
<strong>Default:</strong> <code>false</code>.</li> <li><code>importModuleDynamically</code> {Function} Called during evaluation of this module
when <code>import()</code> is called. If this option is not specified, calls to
<code>import()</code> will reject with <a href="/public/blog/node/errors.html#ERR_VM_DYNAMIC_IMPORT_CALLBACK_MISSING"><code>ERR_VM_DYNAMIC_IMPORT_CALLBACK_MISSING</code></a>.
This option is part of the experimental API for the <code>--experimental-modules</code>
flag, and should not be considered stable.
<ul><li><code>specifier</code> {string} specifier passed to <code>import()</code></li> <li><code>module</code> {vm.Module}</li> <li>Returns: {Module Namespace Object|vm.Module} Returning a <code>vm.Module</code> is
recommended in order to take advantage of error tracking, and to avoid
issues with namespaces that contain <code>then</code> function exports.</li></ul></li></ul></li> <li>Returns: {any} the result of the very last statement executed in the script.</li></ul> <p><code>vm.runInThisContext()</code> compiles <code>code</code>, runs it within the context of the
current <code>global</code> and returns the result. Running code does not have access to
local scope, but does have access to the current <code>global</code> object.</p> <p>If <code>options</code> is a string, then it specifies the filename.</p> <p>The following example illustrates using both <code>vm.runInThisContext()</code> and
the JavaScript <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/eval" target="_blank" rel="noopener noreferrer"><code>eval()</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> function to run the same code:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vm'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> localVar <span class="token operator">=</span> <span class="token string">'initial value'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> vmResult <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">runInThisContext</span><span class="token punctuation">(</span><span class="token string">'localVar = &quot;vm&quot;;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'vmResult:'</span><span class="token punctuation">,</span> vmResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'localVar:'</span><span class="token punctuation">,</span> localVar<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> evalResult <span class="token operator">=</span> <span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">'localVar = &quot;eval&quot;;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'evalResult:'</span><span class="token punctuation">,</span> evalResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'localVar:'</span><span class="token punctuation">,</span> localVar<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// vmResult: 'vm', localVar: 'initial value'</span>
<span class="token comment">// evalResult: 'eval', localVar: 'eval'</span>
</code></pre></div><p>Because <code>vm.runInThisContext()</code> does not have access to the local scope,
<code>localVar</code> is unchanged. In contrast, <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/eval" target="_blank" rel="noopener noreferrer"><code>eval()</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <em>does</em> have access to the
local scope, so the value <code>localVar</code> is changed. In this way
<code>vm.runInThisContext()</code> is much like an <a href="https://es5.github.io/#x10.4.2" target="_blank" rel="noopener noreferrer">indirect <code>eval()</code> call<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, e.g.
<code>(0,eval)('code')</code>.</p> <h2 id="example-running-an-http-server-within-a-vm"><a href="#example-running-an-http-server-within-a-vm" class="header-anchor">#</a> Example: Running an HTTP Server within a VM</h2> <p>When using either <a href="#vm_script_runinthiscontext_options"><code>script.runInThisContext()</code></a> or
<a href="#vm_vm_runinthiscontext_code_options"><code>vm.runInThisContext()</code></a>, the code is executed within the current V8 global
context. The code passed to this VM context will have its own isolated scope.</p> <p>In order to run a simple web server using the <code>http</code> module the code passed to
the context must either call <code>require('http')</code> on its own, or have a reference
to the <code>http</code> module passed to it. For instance:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vm'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
((require) =&gt; {
  const http = require('http');

  http.createServer((request, response) =&gt; {
    response.writeHead(200, { 'Content-Type': 'text/plain' });
    response.end('Hello World\\n');
  }).listen(8124);

  console.log('Server running at http://127.0.0.1:8124/');
})</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

vm<span class="token punctuation">.</span><span class="token function">runInThisContext</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">(</span>require<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The <code>require()</code> in the above case shares the state with the context it is
passed from. This may introduce risks when untrusted code is executed, e.g.
altering objects in the context in unwanted ways.</p> <h2 id="what-does-it-mean-to-contextify-an-object"><a href="#what-does-it-mean-to-contextify-an-object" class="header-anchor">#</a> What does it mean to &quot;contextify&quot; an object?</h2> <p>All JavaScript executed within Node.js runs within the scope of a &quot;context&quot;.
According to the <a href="https://v8.dev/docs/embed#contexts" target="_blank" rel="noopener noreferrer">V8 Embedder's Guide<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>:</p> <blockquote><p>In V8, a context is an execution environment that allows separate, unrelated,
JavaScript applications to run in a single instance of V8. You must explicitly
specify the context in which you want any JavaScript code to be run.</p></blockquote> <p>When the method <code>vm.createContext()</code> is called, the <code>sandbox</code> object that is
passed in (or a newly created object if <code>sandbox</code> is <code>undefined</code>) is associated
internally with a new instance of a V8 Context. This V8 Context provides the
<code>code</code> run using the <code>vm</code> module's methods with an isolated global environment
within which it can operate. The process of creating the V8 Context and
associating it with the <code>sandbox</code> object is what this document refers to as
&quot;contextifying&quot; the <code>sandbox</code>.</p> <h2 id="timeout-limitations-when-using-process-nexttick-promises-and-queuemicrotask"><a href="#timeout-limitations-when-using-process-nexttick-promises-and-queuemicrotask" class="header-anchor">#</a> Timeout limitations when using process.nextTick(), Promises, and queueMicrotask()</h2> <p>Because of the internal mechanics of how the <code>process.nextTick()</code> queue and
the microtask queue that underlies Promises are implemented within V8 and
Node.js, it is possible for code running within a context to &quot;escape&quot; the
<code>timeout</code> set using <code>vm.runInContext()</code>, <code>vm.runInNewContext()</code>, and
<code>vm.runInThisContext()</code>.</p> <p>For example, the following code executed by <code>vm.runInNewContext()</code> with a
timeout of 5 milliseconds schedules an infinite loop to run after a promise
resolves. The scheduled loop is never interrupted by the timeout:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vm'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

vm<span class="token punctuation">.</span><span class="token function">runInNewContext</span><span class="token punctuation">(</span>
  <span class="token string">'Promise.resolve().then(loop);'</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> loop<span class="token punctuation">,</span> console <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> timeout<span class="token punctuation">:</span> <span class="token number">5</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>This issue also occurs when the <code>loop()</code> call is scheduled using
the <code>process.nextTick()</code> and <code>queueMicrotask()</code> functions.</p> <p>This issue occurs because all contexts share the same microtask and nextTick
queues.</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/public/blog/assets/js/app.e4ea57ce.js" defer></script><script src="/public/blog/assets/js/2.d1dd4e4d.js" defer></script><script src="/public/blog/assets/js/60.3e43121d.js" defer></script><script src="/public/blog/assets/js/3.1f730cd9.js" defer></script>
  </body>
</html>
