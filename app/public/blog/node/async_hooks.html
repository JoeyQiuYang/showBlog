<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Async Hooks | QLQ学习平台</title>
    <meta name="description" content="QLQ学习平台">
    <link rel="manifest" href="/public/blog/manifest.json">
    
    <link rel="preload" href="/public/blog/assets/css/0.styles.3ad33863.css" as="style"><link rel="preload" href="/public/blog/assets/js/app.e4ea57ce.js" as="script"><link rel="preload" href="/public/blog/assets/js/2.d1dd4e4d.js" as="script"><link rel="preload" href="/public/blog/assets/js/12.5effa0dc.js" as="script"><link rel="preload" href="/public/blog/assets/js/3.1f730cd9.js" as="script"><link rel="prefetch" href="/public/blog/assets/js/10.7d4b1d4b.js"><link rel="prefetch" href="/public/blog/assets/js/11.b74ab56f.js"><link rel="prefetch" href="/public/blog/assets/js/13.6eb918e8.js"><link rel="prefetch" href="/public/blog/assets/js/14.0de95251.js"><link rel="prefetch" href="/public/blog/assets/js/15.fa3eaaf6.js"><link rel="prefetch" href="/public/blog/assets/js/16.fa5a1f3f.js"><link rel="prefetch" href="/public/blog/assets/js/17.65e33a7a.js"><link rel="prefetch" href="/public/blog/assets/js/18.a604e43f.js"><link rel="prefetch" href="/public/blog/assets/js/19.43fdc1b1.js"><link rel="prefetch" href="/public/blog/assets/js/20.c6e0b4b7.js"><link rel="prefetch" href="/public/blog/assets/js/21.81d73e54.js"><link rel="prefetch" href="/public/blog/assets/js/22.2da1489e.js"><link rel="prefetch" href="/public/blog/assets/js/23.98032a48.js"><link rel="prefetch" href="/public/blog/assets/js/24.bf1aeeb3.js"><link rel="prefetch" href="/public/blog/assets/js/25.ff0a5a9e.js"><link rel="prefetch" href="/public/blog/assets/js/26.9a69e70f.js"><link rel="prefetch" href="/public/blog/assets/js/27.78d71253.js"><link rel="prefetch" href="/public/blog/assets/js/28.05172e35.js"><link rel="prefetch" href="/public/blog/assets/js/29.836b5f2c.js"><link rel="prefetch" href="/public/blog/assets/js/30.7f2a0aa5.js"><link rel="prefetch" href="/public/blog/assets/js/31.16e7c775.js"><link rel="prefetch" href="/public/blog/assets/js/32.9d8aa648.js"><link rel="prefetch" href="/public/blog/assets/js/33.3ad73093.js"><link rel="prefetch" href="/public/blog/assets/js/34.a27e23cf.js"><link rel="prefetch" href="/public/blog/assets/js/35.34f0ba53.js"><link rel="prefetch" href="/public/blog/assets/js/36.993eb43f.js"><link rel="prefetch" href="/public/blog/assets/js/37.70ac44f6.js"><link rel="prefetch" href="/public/blog/assets/js/38.4b9e0ad1.js"><link rel="prefetch" href="/public/blog/assets/js/39.f8c33c98.js"><link rel="prefetch" href="/public/blog/assets/js/4.a6ed393e.js"><link rel="prefetch" href="/public/blog/assets/js/40.a2197e85.js"><link rel="prefetch" href="/public/blog/assets/js/41.467d6440.js"><link rel="prefetch" href="/public/blog/assets/js/42.ba8fc1fa.js"><link rel="prefetch" href="/public/blog/assets/js/43.b9d80aa8.js"><link rel="prefetch" href="/public/blog/assets/js/44.9b55cec1.js"><link rel="prefetch" href="/public/blog/assets/js/45.fbd44db5.js"><link rel="prefetch" href="/public/blog/assets/js/46.cff257a8.js"><link rel="prefetch" href="/public/blog/assets/js/47.3cd816de.js"><link rel="prefetch" href="/public/blog/assets/js/48.fdd057cb.js"><link rel="prefetch" href="/public/blog/assets/js/49.e007afae.js"><link rel="prefetch" href="/public/blog/assets/js/5.868620b4.js"><link rel="prefetch" href="/public/blog/assets/js/50.05e06075.js"><link rel="prefetch" href="/public/blog/assets/js/51.28689d1c.js"><link rel="prefetch" href="/public/blog/assets/js/52.84b0ef5c.js"><link rel="prefetch" href="/public/blog/assets/js/53.586cad0a.js"><link rel="prefetch" href="/public/blog/assets/js/54.2b8a703d.js"><link rel="prefetch" href="/public/blog/assets/js/55.c466c411.js"><link rel="prefetch" href="/public/blog/assets/js/56.882ab9d2.js"><link rel="prefetch" href="/public/blog/assets/js/57.edaca7e3.js"><link rel="prefetch" href="/public/blog/assets/js/58.c7ce4964.js"><link rel="prefetch" href="/public/blog/assets/js/59.02f33b29.js"><link rel="prefetch" href="/public/blog/assets/js/6.8e0ec0a1.js"><link rel="prefetch" href="/public/blog/assets/js/60.3e43121d.js"><link rel="prefetch" href="/public/blog/assets/js/61.e73a45bf.js"><link rel="prefetch" href="/public/blog/assets/js/62.a1ea2161.js"><link rel="prefetch" href="/public/blog/assets/js/63.0a4a98df.js"><link rel="prefetch" href="/public/blog/assets/js/64.0422c733.js"><link rel="prefetch" href="/public/blog/assets/js/65.b26f077a.js"><link rel="prefetch" href="/public/blog/assets/js/7.287519a5.js"><link rel="prefetch" href="/public/blog/assets/js/8.5443f788.js"><link rel="prefetch" href="/public/blog/assets/js/9.ef0461e8.js">
    <link rel="stylesheet" href="/public/blog/assets/css/0.styles.3ad33863.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/public/blog/" class="home-link router-link-active"><!----> <span class="site-name">QLQ学习平台</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/public/blog/js/regexp.html" class="nav-link">javaScript</a></div><div class="nav-item"><a href="/public/blog/css/bfc.html" class="nav-link">css</a></div><div class="nav-item"><a href="/public/blog/webpack/base-config.html" class="nav-link">webpack</a></div><div class="nav-item"><a href="/public/blog/node/buffer.html" class="nav-link">node</a></div><div class="nav-item"><a href="/public/blog/fragment/angular.html" class="nav-link">js框架</a></div><div class="nav-item"><a href="/public/blog/pwa/PWA.html" class="nav-link">pwa</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/public/blog/js/regexp.html" class="nav-link">javaScript</a></div><div class="nav-item"><a href="/public/blog/css/bfc.html" class="nav-link">css</a></div><div class="nav-item"><a href="/public/blog/webpack/base-config.html" class="nav-link">webpack</a></div><div class="nav-item"><a href="/public/blog/node/buffer.html" class="nav-link">node</a></div><div class="nav-item"><a href="/public/blog/fragment/angular.html" class="nav-link">js框架</a></div><div class="nav-item"><a href="/public/blog/pwa/PWA.html" class="nav-link">pwa</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>node</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/public/blog/node/buffer.html" class="sidebar-link">Buffer</a></li><li><a href="/public/blog/node/stream.html" class="sidebar-link">Stream</a></li><li><a href="/public/blog/node/nodemon.html" class="sidebar-link">nodemon：高效的nodejs开发环境</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="async-hooks"><a href="#async-hooks" class="header-anchor">#</a> Async Hooks</h1> <blockquote><p>Stability: 1 - Experimental</p></blockquote> <p>The <code>async_hooks</code> module provides an API to register callbacks tracking the
lifetime of asynchronous resources created inside a Node.js application.
It can be accessed using:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> async_hooks <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'async_hooks'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="terminology"><a href="#terminology" class="header-anchor">#</a> Terminology</h2> <p>An asynchronous resource represents an object with an associated callback.
This callback may be called multiple times, for example, the <code>'connection'</code>
event in <code>net.createServer()</code>, or just a single time like in <code>fs.open()</code>.
A resource can also be closed before the callback is called. <code>AsyncHook</code> does
not explicitly distinguish between these different cases but will represent them
as the abstract concept that is a resource.</p> <p>If <a href="/public/blog/node/worker_threads.html#worker_threads_class_worker"><code>Worker</code></a>s are used, each thread has an independent <code>async_hooks</code>
interface, and each thread will use a new set of async IDs.</p> <h2 id="public-api"><a href="#public-api" class="header-anchor">#</a> Public API</h2> <h3 id="overview"><a href="#overview" class="header-anchor">#</a> Overview</h3> <p>Following is a simple overview of the public API.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> async_hooks <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'async_hooks'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Return the ID of the current execution context.</span>
<span class="token keyword">const</span> eid <span class="token operator">=</span> async_hooks<span class="token punctuation">.</span><span class="token function">executionAsyncId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Return the ID of the handle responsible for triggering the callback of the</span>
<span class="token comment">// current execution scope to call.</span>
<span class="token keyword">const</span> tid <span class="token operator">=</span> async_hooks<span class="token punctuation">.</span><span class="token function">triggerAsyncId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Create a new AsyncHook instance. All of these callbacks are optional.</span>
<span class="token keyword">const</span> asyncHook <span class="token operator">=</span>
    async_hooks<span class="token punctuation">.</span><span class="token function">createHook</span><span class="token punctuation">(</span><span class="token punctuation">{</span> init<span class="token punctuation">,</span> before<span class="token punctuation">,</span> after<span class="token punctuation">,</span> destroy<span class="token punctuation">,</span> promiseResolve <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Allow callbacks of this AsyncHook instance to call. This is not an implicit</span>
<span class="token comment">// action after running the constructor, and must be explicitly run to begin</span>
<span class="token comment">// executing callbacks.</span>
asyncHook<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Disable listening for new asynchronous events.</span>
asyncHook<span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//</span>
<span class="token comment">// The following are the callbacks that can be passed to createHook().</span>
<span class="token comment">//</span>

<span class="token comment">// init is called during object construction. The resource may not have</span>
<span class="token comment">// completed construction when this callback runs, therefore all fields of the</span>
<span class="token comment">// resource referenced by &quot;asyncId&quot; may not have been populated.</span>
<span class="token keyword">function</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token parameter">asyncId<span class="token punctuation">,</span> type<span class="token punctuation">,</span> triggerAsyncId<span class="token punctuation">,</span> resource</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

<span class="token comment">// Before is called just before the resource's callback is called. It can be</span>
<span class="token comment">// called 0-N times for handles (e.g. TCPWrap), and will be called exactly 1</span>
<span class="token comment">// time for requests (e.g. FSReqCallback).</span>
<span class="token keyword">function</span> <span class="token function">before</span><span class="token punctuation">(</span><span class="token parameter">asyncId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

<span class="token comment">// After is called just after the resource's callback has finished.</span>
<span class="token keyword">function</span> <span class="token function">after</span><span class="token punctuation">(</span><span class="token parameter">asyncId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

<span class="token comment">// Destroy is called when an AsyncWrap instance is destroyed.</span>
<span class="token keyword">function</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token parameter">asyncId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

<span class="token comment">// promiseResolve is called only for promise resources, when the</span>
<span class="token comment">// `resolve` function passed to the `Promise` constructor is invoked</span>
<span class="token comment">// (either directly or through other means of resolving a promise).</span>
<span class="token keyword">function</span> <span class="token function">promiseResolve</span><span class="token punctuation">(</span><span class="token parameter">asyncId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
</code></pre></div><h4 id="async-hooks-createhook-callbacks"><a href="#async-hooks-createhook-callbacks" class="header-anchor">#</a> async_hooks.createHook(callbacks)</h4> <ul><li><code>callbacks</code> {Object} The <a href="#async_hooks_hook_callbacks">Hook Callbacks</a> to register
<ul><li><code>init</code> {Function} The <a href="#async_hooks_init_asyncid_type_triggerasyncid_resource"><code>init</code> callback</a>.</li> <li><code>before</code> {Function} The <a href="#async_hooks_before_asyncid"><code>before</code> callback</a>.</li> <li><code>after</code> {Function} The <a href="#async_hooks_after_asyncid"><code>after</code> callback</a>.</li> <li><code>destroy</code> {Function} The <a href="#async_hooks_destroy_asyncid"><code>destroy</code> callback</a>.</li> <li><code>promiseResolve</code> {Function} The <a href="#async_hooks_promiseresolve_asyncid"><code>promiseResolve</code> callback</a>.</li></ul></li> <li>Returns: {AsyncHook} Instance used for disabling and enabling hooks</li></ul> <p>Registers functions to be called for different lifetime events of each async
operation.</p> <p>The callbacks <code>init()</code>/<code>before()</code>/<code>after()</code>/<code>destroy()</code> are called for the
respective asynchronous event during a resource's lifetime.</p> <p>All callbacks are optional. For example, if only resource cleanup needs to
be tracked, then only the <code>destroy</code> callback needs to be passed. The
specifics of all functions that can be passed to <code>callbacks</code> is in the
<a href="#async_hooks_hook_callbacks">Hook Callbacks</a> section.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> async_hooks <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'async_hooks'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> asyncHook <span class="token operator">=</span> async_hooks<span class="token punctuation">.</span><span class="token function">createHook</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">init</span><span class="token punctuation">(</span><span class="token parameter">asyncId<span class="token punctuation">,</span> type<span class="token punctuation">,</span> triggerAsyncId<span class="token punctuation">,</span> resource</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token parameter">asyncId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The callbacks will be inherited via the prototype chain:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">MyAsyncCallbacks</span> <span class="token punctuation">{</span>
  <span class="token function">init</span><span class="token punctuation">(</span><span class="token parameter">asyncId<span class="token punctuation">,</span> type<span class="token punctuation">,</span> triggerAsyncId<span class="token punctuation">,</span> resource</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
  <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token parameter">asyncId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">MyAddedCallbacks</span> <span class="token keyword">extends</span> <span class="token class-name">MyAsyncCallbacks</span> <span class="token punctuation">{</span>
  <span class="token function">before</span><span class="token punctuation">(</span><span class="token parameter">asyncId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
  <span class="token function">after</span><span class="token punctuation">(</span><span class="token parameter">asyncId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> asyncHook <span class="token operator">=</span> async_hooks<span class="token punctuation">.</span><span class="token function">createHook</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyAddedCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h5 id="error-handling"><a href="#error-handling" class="header-anchor">#</a> Error Handling</h5> <p>If any <code>AsyncHook</code> callbacks throw, the application will print the stack trace
and exit. The exit path does follow that of an uncaught exception, but
all <code>'uncaughtException'</code> listeners are removed, thus forcing the process to
exit. The <code>'exit'</code> callbacks will still be called unless the application is run
with <code>--abort-on-uncaught-exception</code>, in which case a stack trace will be
printed and the application exits, leaving a core file.</p> <p>The reason for this error handling behavior is that these callbacks are running
at potentially volatile points in an object's lifetime, for example during
class construction and destruction. Because of this, it is deemed necessary to
bring down the process quickly in order to prevent an unintentional abort in the
future. This is subject to change in the future if a comprehensive analysis is
performed to ensure an exception can follow the normal control flow without
unintentional side effects.</p> <h5 id="printing-in-asynchooks-callbacks"><a href="#printing-in-asynchooks-callbacks" class="header-anchor">#</a> Printing in AsyncHooks callbacks</h5> <p>Because printing to the console is an asynchronous operation, <code>console.log()</code>
will cause the AsyncHooks callbacks to be called. Using <code>console.log()</code> or
similar asynchronous operations inside an AsyncHooks callback function will thus
cause an infinite recursion. An easy solution to this when debugging is to use a
synchronous logging operation such as <code>fs.writeFileSync(file, msg, flag)</code>.
This will print to the file and will not invoke AsyncHooks recursively because
it is synchronous.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> util <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'util'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">debug</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Use a function like this one when debugging inside an AsyncHooks callback</span>
  fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span><span class="token string">'log.out'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>util<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span> flag<span class="token punctuation">:</span> <span class="token string">'a'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>If an asynchronous operation is needed for logging, it is possible to keep
track of what caused the asynchronous operation using the information
provided by AsyncHooks itself. The logging should then be skipped when
it was the logging itself that caused AsyncHooks callback to call. By
doing this the otherwise infinite recursion is broken.</p> <h4 id="asynchook-enable"><a href="#asynchook-enable" class="header-anchor">#</a> asyncHook.enable()</h4> <ul><li>Returns: {AsyncHook} A reference to <code>asyncHook</code>.</li></ul> <p>Enable the callbacks for a given <code>AsyncHook</code> instance. If no callbacks are
provided enabling is a noop.</p> <p>The <code>AsyncHook</code> instance is disabled by default. If the <code>AsyncHook</code> instance
should be enabled immediately after creation, the following pattern can be used.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> async_hooks <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'async_hooks'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> hook <span class="token operator">=</span> async_hooks<span class="token punctuation">.</span><span class="token function">createHook</span><span class="token punctuation">(</span>callbacks<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="asynchook-disable"><a href="#asynchook-disable" class="header-anchor">#</a> asyncHook.disable()</h4> <ul><li>Returns: {AsyncHook} A reference to <code>asyncHook</code>.</li></ul> <p>Disable the callbacks for a given <code>AsyncHook</code> instance from the global pool of
<code>AsyncHook</code> callbacks to be executed. Once a hook has been disabled it will not
be called again until enabled.</p> <p>For API consistency <code>disable()</code> also returns the <code>AsyncHook</code> instance.</p> <h4 id="hook-callbacks"><a href="#hook-callbacks" class="header-anchor">#</a> Hook Callbacks</h4> <p>Key events in the lifetime of asynchronous events have been categorized into
four areas: instantiation, before/after the callback is called, and when the
instance is destroyed.</p> <h5 id="init-asyncid-type-triggerasyncid-resource"><a href="#init-asyncid-type-triggerasyncid-resource" class="header-anchor">#</a> init(asyncId, type, triggerAsyncId, resource)</h5> <ul><li><code>asyncId</code> {number} A unique ID for the async resource.</li> <li><code>type</code> {string} The type of the async resource.</li> <li><code>triggerAsyncId</code> {number} The unique ID of the async resource in whose
execution context this async resource was created.</li> <li><code>resource</code> {Object} Reference to the resource representing the async
operation, needs to be released during <em>destroy</em>.</li></ul> <p>Called when a class is constructed that has the <em>possibility</em> to emit an
asynchronous event. This <em>does not</em> mean the instance must call
<code>before</code>/<code>after</code> before <code>destroy</code> is called, only that the possibility
exists.</p> <p>This behavior can be observed by doing something like opening a resource then
closing it before the resource can be used. The following snippet demonstrates
this.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'net'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// OR</span>
<span class="token function">clearTimeout</span><span class="token punctuation">(</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Every new resource is assigned an ID that is unique within the scope of the
current Node.js instance.</p> <h6 id="type"><a href="#type" class="header-anchor">#</a> <code>type</code></h6> <p>The <code>type</code> is a string identifying the type of resource that caused
<code>init</code> to be called. Generally, it will correspond to the name of the
resource's constructor.</p> <div class="language-text extra-class"><pre class="language-text"><code>FSEVENTWRAP, FSREQCALLBACK, GETADDRINFOREQWRAP, GETNAMEINFOREQWRAP, HTTPINCOMINGMESSAGE,
HTTPCLIENTREQUEST, JSSTREAM, PIPECONNECTWRAP, PIPEWRAP, PROCESSWRAP, QUERYWRAP,
SHUTDOWNWRAP, SIGNALWRAP, STATWATCHER, TCPCONNECTWRAP, TCPSERVERWRAP, TCPWRAP,
TTYWRAP, UDPSENDWRAP, UDPWRAP, WRITEWRAP, ZLIB, SSLCONNECTION, PBKDF2REQUEST,
RANDOMBYTESREQUEST, TLSWRAP, Microtask, Timeout, Immediate, TickObject
</code></pre></div><p>There is also the <code>PROMISE</code> resource type, which is used to track <code>Promise</code>
instances and asynchronous work scheduled by them.</p> <p>Users are able to define their own <code>type</code> when using the public embedder API.</p> <p>It is possible to have type name collisions. Embedders are encouraged to use
unique prefixes, such as the npm package name, to prevent collisions when
listening to the hooks.</p> <h6 id="triggerasyncid"><a href="#triggerasyncid" class="header-anchor">#</a> <code>triggerAsyncId</code></h6> <p><code>triggerAsyncId</code> is the <code>asyncId</code> of the resource that caused (or &quot;triggered&quot;)
the new resource to initialize and that caused <code>init</code> to call. This is different
from <code>async_hooks.executionAsyncId()</code> that only shows <em>when</em> a resource was
created, while <code>triggerAsyncId</code> shows <em>why</em> a resource was created.</p> <p>The following is a simple demonstration of <code>triggerAsyncId</code>:</p> <div class="language-js extra-class"><pre class="language-js"><code>async_hooks<span class="token punctuation">.</span><span class="token function">createHook</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">init</span><span class="token punctuation">(</span><span class="token parameter">asyncId<span class="token punctuation">,</span> type<span class="token punctuation">,</span> triggerAsyncId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> eid <span class="token operator">=</span> async_hooks<span class="token punctuation">.</span><span class="token function">executionAsyncId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    fs<span class="token punctuation">.</span><span class="token function">writeSync</span><span class="token punctuation">(</span>
      <span class="token number">1</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>asyncId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">): trigger: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>triggerAsyncId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> execution: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>eid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'net'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">conn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Output when hitting the server with <code>nc localhost 8080</code>:</p> <div class="language-console extra-class"><pre class="language-text"><code>TCPSERVERWRAP(5): trigger: 1 execution: 1
TCPWRAP(7): trigger: 5 execution: 0
</code></pre></div><p>The <code>TCPSERVERWRAP</code> is the server which receives the connections.</p> <p>The <code>TCPWRAP</code> is the new connection from the client. When a new
connection is made, the <code>TCPWrap</code> instance is immediately constructed. This
happens outside of any JavaScript stack. (An <code>executionAsyncId()</code> of <code>0</code> means
that it is being executed from C++ with no JavaScript stack above it.) With only
that information, it would be impossible to link resources together in
terms of what caused them to be created, so <code>triggerAsyncId</code> is given the task
of propagating what resource is responsible for the new resource's existence.</p> <h6 id="resource"><a href="#resource" class="header-anchor">#</a> <code>resource</code></h6> <p><code>resource</code> is an object that represents the actual async resource that has
been initialized. This can contain useful information that can vary based on
the value of <code>type</code>. For instance, for the <code>GETADDRINFOREQWRAP</code> resource type,
<code>resource</code> provides the hostname used when looking up the IP address for the
host in <code>net.Server.listen()</code>. The API for accessing this information is
currently not considered public, but using the Embedder API, users can provide
and document their own resource objects. For example, such a resource object
could contain the SQL query being executed.</p> <p>In the case of Promises, the <code>resource</code> object will have an
<code>isChainedPromise</code> property, set to <code>true</code> if the promise has a parent promise,
and <code>false</code> otherwise. For example, in the case of <code>b = a.then(handler)</code>, <code>a</code> is
considered a parent <code>Promise</code> of <code>b</code>. Here, <code>b</code> is considered a chained promise.</p> <p>In some cases the resource object is reused for performance reasons, it is
thus not safe to use it as a key in a <code>WeakMap</code> or add properties to it.</p> <h6 id="asynchronous-context-example"><a href="#asynchronous-context-example" class="header-anchor">#</a> Asynchronous context example</h6> <p>The following is an example with additional information about the calls to
<code>init</code> between the <code>before</code> and <code>after</code> calls, specifically what the
callback to <code>listen()</code> will look like. The output formatting is slightly more
elaborate to make calling context easier to see.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> indent <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
async_hooks<span class="token punctuation">.</span><span class="token function">createHook</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">init</span><span class="token punctuation">(</span><span class="token parameter">asyncId<span class="token punctuation">,</span> type<span class="token punctuation">,</span> triggerAsyncId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> eid <span class="token operator">=</span> async_hooks<span class="token punctuation">.</span><span class="token function">executionAsyncId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> indentStr <span class="token operator">=</span> <span class="token string">' '</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span>indent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    fs<span class="token punctuation">.</span><span class="token function">writeSync</span><span class="token punctuation">(</span>
      <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>indentStr<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>asyncId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">):</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> trigger: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>triggerAsyncId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> execution: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>eid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">before</span><span class="token punctuation">(</span><span class="token parameter">asyncId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> indentStr <span class="token operator">=</span> <span class="token string">' '</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span>indent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span><span class="token string">'log.out'</span><span class="token punctuation">,</span>
                     <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>indentStr<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">before:  </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>asyncId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span> flag<span class="token punctuation">:</span> <span class="token string">'a'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    indent <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">after</span><span class="token punctuation">(</span><span class="token parameter">asyncId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    indent <span class="token operator">-=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> indentStr <span class="token operator">=</span> <span class="token string">' '</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span>indent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span><span class="token string">'log.out'</span><span class="token punctuation">,</span>
                     <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>indentStr<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">after:  </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>asyncId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span> flag<span class="token punctuation">:</span> <span class="token string">'a'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token parameter">asyncId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> indentStr <span class="token operator">=</span> <span class="token string">' '</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span>indent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span><span class="token string">'log.out'</span><span class="token punctuation">,</span>
                     <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>indentStr<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">destroy:  </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>asyncId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span> flag<span class="token punctuation">:</span> <span class="token string">'a'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'net'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Let's wait 10ms before logging the server started.</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'&gt;&gt;&gt;'</span><span class="token punctuation">,</span> async_hooks<span class="token punctuation">.</span><span class="token function">executionAsyncId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Output from only starting the server:</p> <div class="language-console extra-class"><pre class="language-text"><code>TCPSERVERWRAP(5): trigger: 1 execution: 1
TickObject(6): trigger: 5 execution: 1
before:  6
  Timeout(7): trigger: 6 execution: 6
after:   6
destroy: 6
before:  7
&gt;&gt;&gt; 7
  TickObject(8): trigger: 7 execution: 7
after:   7
before:  8
after:   8
</code></pre></div><p>As illustrated in the example, <code>executionAsyncId()</code> and <code>execution</code> each specify
the value of the current execution context; which is delineated by calls to
<code>before</code> and <code>after</code>.</p> <p>Only using <code>execution</code> to graph resource allocation results in the following:</p> <div class="language-console extra-class"><pre class="language-text"><code>Timeout(7) -&gt; TickObject(6) -&gt; root(1)
</code></pre></div><p>The <code>TCPSERVERWRAP</code> is not part of this graph, even though it was the reason for
<code>console.log()</code> being called. This is because binding to a port without a
hostname is a <em>synchronous</em> operation, but to maintain a completely asynchronous
API the user's callback is placed in a <code>process.nextTick()</code>.</p> <p>The graph only shows <em>when</em> a resource was created, not <em>why</em>, so to track
the <em>why</em> use <code>triggerAsyncId</code>.</p> <h5 id="before-asyncid"><a href="#before-asyncid" class="header-anchor">#</a> before(asyncId)</h5> <ul><li><code>asyncId</code> {number}</li></ul> <p>When an asynchronous operation is initiated (such as a TCP server receiving a
new connection) or completes (such as writing data to disk) a callback is
called to notify the user. The <code>before</code> callback is called just before said
callback is executed. <code>asyncId</code> is the unique identifier assigned to the
resource about to execute the callback.</p> <p>The <code>before</code> callback will be called 0 to N times. The <code>before</code> callback
will typically be called 0 times if the asynchronous operation was cancelled
or, for example, if no connections are received by a TCP server. Persistent
asynchronous resources like a TCP server will typically call the <code>before</code>
callback multiple times, while other operations like <code>fs.open()</code> will call
it only once.</p> <h5 id="after-asyncid"><a href="#after-asyncid" class="header-anchor">#</a> after(asyncId)</h5> <ul><li><code>asyncId</code> {number}</li></ul> <p>Called immediately after the callback specified in <code>before</code> is completed.</p> <p>If an uncaught exception occurs during execution of the callback, then <code>after</code>
will run <em>after</em> the <code>'uncaughtException'</code> event is emitted or a <code>domain</code>'s
handler runs.</p> <h5 id="destroy-asyncid"><a href="#destroy-asyncid" class="header-anchor">#</a> destroy(asyncId)</h5> <ul><li><code>asyncId</code> {number}</li></ul> <p>Called after the resource corresponding to <code>asyncId</code> is destroyed. It is also
called asynchronously from the embedder API <code>emitDestroy()</code>.</p> <p>Some resources depend on garbage collection for cleanup, so if a reference is
made to the <code>resource</code> object passed to <code>init</code> it is possible that <code>destroy</code>
will never be called, causing a memory leak in the application. If the resource
does not depend on garbage collection, then this will not be an issue.</p> <h5 id="promiseresolve-asyncid"><a href="#promiseresolve-asyncid" class="header-anchor">#</a> promiseResolve(asyncId)</h5> <ul><li><code>asyncId</code> {number}</li></ul> <p>Called when the <code>resolve</code> function passed to the <code>Promise</code> constructor is
invoked (either directly or through other means of resolving a promise).</p> <p><code>resolve()</code> does not do any observable synchronous work.</p> <p>The <code>Promise</code> is not necessarily fulfilled or rejected at this point if the
<code>Promise</code> was resolved by assuming the state of another <code>Promise</code>.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>calls the following callbacks:</p> <div class="language-text extra-class"><pre class="language-text"><code>init for PROMISE with id 5, trigger id: 1
  promise resolve 5      # corresponds to resolve(true)
init for PROMISE with id 6, trigger id: 5  # the Promise returned by then()
  before 6               # the then() callback is entered
  promise resolve 6      # the then() callback resolves the promise by returning
  after 6
</code></pre></div><h4 id="async-hooks-executionasyncid"><a href="#async-hooks-executionasyncid" class="header-anchor">#</a> async_hooks.executionAsyncId()</h4> <ul><li>Returns: {number} The <code>asyncId</code> of the current execution context. Useful to
track when something calls.</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> async_hooks <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'async_hooks'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>async_hooks<span class="token punctuation">.</span><span class="token function">executionAsyncId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 1 - bootstrap</span>
fs<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> fd</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>async_hooks<span class="token punctuation">.</span><span class="token function">executionAsyncId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 6 - open()</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The ID returned from <code>executionAsyncId()</code> is related to execution timing, not
causality (which is covered by <code>triggerAsyncId()</code>):</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> server <span class="token operator">=</span> net<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">conn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Returns the ID of the server, not of the new connection, because the</span>
  <span class="token comment">// callback runs in the execution scope of the server's MakeCallback().</span>
  async_hooks<span class="token punctuation">.</span><span class="token function">executionAsyncId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Returns the ID of a TickObject (i.e. process.nextTick()) because all</span>
  <span class="token comment">// callbacks passed to .listen() are wrapped in a nextTick().</span>
  async_hooks<span class="token punctuation">.</span><span class="token function">executionAsyncId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Promise contexts may not get precise <code>executionAsyncIds</code> by default.
See the section on <a href="#async_hooks_promise_execution_tracking">promise execution tracking</a>.</p> <h4 id="async-hooks-triggerasyncid"><a href="#async-hooks-triggerasyncid" class="header-anchor">#</a> async_hooks.triggerAsyncId()</h4> <ul><li>Returns: {number} The ID of the resource responsible for calling the callback
that is currently being executed.</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> server <span class="token operator">=</span> net<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">conn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// The resource that caused (or triggered) this callback to be called</span>
  <span class="token comment">// was that of the new connection. Thus the return value of triggerAsyncId()</span>
  <span class="token comment">// is the asyncId of &quot;conn&quot;.</span>
  async_hooks<span class="token punctuation">.</span><span class="token function">triggerAsyncId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Even though all callbacks passed to .listen() are wrapped in a nextTick()</span>
  <span class="token comment">// the callback itself exists because the call to the server's .listen()</span>
  <span class="token comment">// was made. So the return value would be the ID of the server.</span>
  async_hooks<span class="token punctuation">.</span><span class="token function">triggerAsyncId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Promise contexts may not get valid <code>triggerAsyncId</code>s by default. See
the section on <a href="#async_hooks_promise_execution_tracking">promise execution tracking</a>.</p> <h2 id="promise-execution-tracking"><a href="#promise-execution-tracking" class="header-anchor">#</a> Promise execution tracking</h2> <p>By default, promise executions are not assigned <code>asyncId</code>s due to the relatively
expensive nature of the <a href="https://docs.google.com/document/d/1rda3yKGHimKIhg5YeoAmCOtyURgsbTH_qaYR79FELlk/edit" target="_blank" rel="noopener noreferrer">promise introspection API<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> provided by
V8. This means that programs using promises or <code>async</code>/<code>await</code> will not get
correct execution and trigger ids for promise callback contexts by default.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> ah <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'async_hooks'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1729</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">eid </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ah<span class="token punctuation">.</span><span class="token function">executionAsyncId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> tid </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ah<span class="token punctuation">.</span><span class="token function">triggerAsyncId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// produces:</span>
<span class="token comment">// eid 1 tid 0</span>
</code></pre></div><p>Observe that the <code>then()</code> callback claims to have executed in the context of the
outer scope even though there was an asynchronous hop involved. Also,
the <code>triggerAsyncId</code> value is <code>0</code>, which means that we are missing context about
the resource that caused (triggered) the <code>then()</code> callback to be executed.</p> <p>Installing async hooks via <code>async_hooks.createHook</code> enables promise execution
tracking:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> ah <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'async_hooks'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ah<span class="token punctuation">.</span><span class="token function">createHook</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// forces PromiseHooks to be enabled.</span>
Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1729</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">eid </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ah<span class="token punctuation">.</span><span class="token function">executionAsyncId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> tid </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ah<span class="token punctuation">.</span><span class="token function">triggerAsyncId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// produces:</span>
<span class="token comment">// eid 7 tid 6</span>
</code></pre></div><p>In this example, adding any actual hook function enabled the tracking of
promises. There are two promises in the example above; the promise created by
<code>Promise.resolve()</code> and the promise returned by the call to <code>then()</code>. In the
example above, the first promise got the <code>asyncId</code> <code>6</code> and the latter got
<code>asyncId</code> <code>7</code>. During the execution of the <code>then()</code> callback, we are executing
in the context of promise with <code>asyncId</code> <code>7</code>. This promise was triggered by
async resource <code>6</code>.</p> <p>Another subtlety with promises is that <code>before</code> and <code>after</code> callbacks are run
only on chained promises. That means promises not created by <code>then()</code>/<code>catch()</code>
will not have the <code>before</code> and <code>after</code> callbacks fired on them. For more details
see the details of the V8 <a href="https://docs.google.com/document/d/1rda3yKGHimKIhg5YeoAmCOtyURgsbTH_qaYR79FELlk/edit" target="_blank" rel="noopener noreferrer">PromiseHooks<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> API.</p> <h2 id="javascript-embedder-api"><a href="#javascript-embedder-api" class="header-anchor">#</a> JavaScript Embedder API</h2> <p>Library developers that handle their own asynchronous resources performing tasks
like I/O, connection pooling, or managing callback queues may use the
<code>AsyncWrap</code> JavaScript API so that all the appropriate callbacks are called.</p> <h3 id="class-asyncresource"><a href="#class-asyncresource" class="header-anchor">#</a> Class: AsyncResource</h3> <p>The class <code>AsyncResource</code> is designed to be extended by the embedder's async
resources. Using this, users can easily trigger the lifetime events of their
own resources.</p> <p>The <code>init</code> hook will trigger when an <code>AsyncResource</code> is instantiated.</p> <p>The following is an overview of the <code>AsyncResource</code> API.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> AsyncResource<span class="token punctuation">,</span> executionAsyncId <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'async_hooks'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// AsyncResource() is meant to be extended. Instantiating a</span>
<span class="token comment">// new AsyncResource() also triggers init. If triggerAsyncId is omitted then</span>
<span class="token comment">// async_hook.executionAsyncId() is used.</span>
<span class="token keyword">const</span> asyncResource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncResource</span><span class="token punctuation">(</span>
  type<span class="token punctuation">,</span> <span class="token punctuation">{</span> triggerAsyncId<span class="token punctuation">:</span> <span class="token function">executionAsyncId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requireManualDestroy<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Run a function in the execution context of the resource. This will</span>
<span class="token comment">// * establish the context of the resource</span>
<span class="token comment">// * trigger the AsyncHooks before callbacks</span>
<span class="token comment">// * call the provided function `fn` with the supplied arguments</span>
<span class="token comment">// * trigger the AsyncHooks after callbacks</span>
<span class="token comment">// * restore the original execution context</span>
asyncResource<span class="token punctuation">.</span><span class="token function">runInAsyncScope</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> thisArg<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Call AsyncHooks destroy callbacks.</span>
asyncResource<span class="token punctuation">.</span><span class="token function">emitDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Return the unique ID assigned to the AsyncResource instance.</span>
asyncResource<span class="token punctuation">.</span><span class="token function">asyncId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Return the trigger ID for the AsyncResource instance.</span>
asyncResource<span class="token punctuation">.</span><span class="token function">triggerAsyncId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="new-asyncresource-type-options"><a href="#new-asyncresource-type-options" class="header-anchor">#</a> new AsyncResource(type[, options])</h4> <ul><li><code>type</code> {string} The type of async event.</li> <li><code>options</code> {Object}
<ul><li><code>triggerAsyncId</code> {number} The ID of the execution context that created this
async event. <strong>Default:</strong> <code>executionAsyncId()</code>.</li> <li><code>requireManualDestroy</code> {boolean} Disables automatic <code>emitDestroy</code> when the
object is garbage collected. This usually does not need to be set (even if
<code>emitDestroy</code> is called manually), unless the resource's <code>asyncId</code> is
retrieved and the sensitive API's <code>emitDestroy</code> is called with it.
<strong>Default:</strong> <code>false</code>.</li></ul></li></ul> <p>Example usage:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">DBQuery</span> <span class="token keyword">extends</span> <span class="token class-name">AsyncResource</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">db</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token string">'DBQuery'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>db <span class="token operator">=</span> db<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token parameter">query<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>db<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">runInAsyncScope</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> err<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>db <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emitDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="asyncresource-runinasyncscope-fn-thisarg-args"><a href="#asyncresource-runinasyncscope-fn-thisarg-args" class="header-anchor">#</a> asyncResource.runInAsyncScope(fn[, thisArg, ...args])</h4> <ul><li><code>fn</code> {Function} The function to call in the execution context of this async
resource.</li> <li><code>thisArg</code> {any} The receiver to be used for the function call.</li> <li><code>...args</code> {any} Optional arguments to pass to the function.</li></ul> <p>Call the provided function with the provided arguments in the execution context
of the async resource. This will establish the context, trigger the AsyncHooks
before callbacks, call the function, trigger the AsyncHooks after callbacks, and
then restore the original execution context.</p> <h4 id="asyncresource-emitdestroy"><a href="#asyncresource-emitdestroy" class="header-anchor">#</a> asyncResource.emitDestroy()</h4> <ul><li>Returns: {AsyncResource} A reference to <code>asyncResource</code>.</li></ul> <p>Call all <code>destroy</code> hooks. This should only ever be called once. An error will
be thrown if it is called more than once. This <strong>must</strong> be manually called. If
the resource is left to be collected by the GC then the <code>destroy</code> hooks will
never be called.</p> <h4 id="asyncresource-asyncid"><a href="#asyncresource-asyncid" class="header-anchor">#</a> asyncResource.asyncId()</h4> <ul><li>Returns: {number} The unique <code>asyncId</code> assigned to the resource.</li></ul> <h4 id="asyncresource-triggerasyncid"><a href="#asyncresource-triggerasyncid" class="header-anchor">#</a> asyncResource.triggerAsyncId()</h4> <ul><li>Returns: {number} The same <code>triggerAsyncId</code> that is passed to the
<code>AsyncResource</code> constructor.</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/public/blog/assets/js/app.e4ea57ce.js" defer></script><script src="/public/blog/assets/js/2.d1dd4e4d.js" defer></script><script src="/public/blog/assets/js/12.5effa0dc.js" defer></script><script src="/public/blog/assets/js/3.1f730cd9.js" defer></script>
  </body>
</html>
