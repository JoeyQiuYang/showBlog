<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Policies | QLQ学习平台</title>
    <meta name="description" content="QLQ学习平台">
    <link rel="manifest" href="/public/blog/manifest.json">
    
    <link rel="preload" href="/public/blog/assets/css/0.styles.3ad33863.css" as="style"><link rel="preload" href="/public/blog/assets/js/app.e4ea57ce.js" as="script"><link rel="preload" href="/public/blog/assets/js/2.d1dd4e4d.js" as="script"><link rel="preload" href="/public/blog/assets/js/43.b9d80aa8.js" as="script"><link rel="preload" href="/public/blog/assets/js/3.1f730cd9.js" as="script"><link rel="prefetch" href="/public/blog/assets/js/10.7d4b1d4b.js"><link rel="prefetch" href="/public/blog/assets/js/11.b74ab56f.js"><link rel="prefetch" href="/public/blog/assets/js/12.5effa0dc.js"><link rel="prefetch" href="/public/blog/assets/js/13.6eb918e8.js"><link rel="prefetch" href="/public/blog/assets/js/14.0de95251.js"><link rel="prefetch" href="/public/blog/assets/js/15.fa3eaaf6.js"><link rel="prefetch" href="/public/blog/assets/js/16.fa5a1f3f.js"><link rel="prefetch" href="/public/blog/assets/js/17.65e33a7a.js"><link rel="prefetch" href="/public/blog/assets/js/18.a604e43f.js"><link rel="prefetch" href="/public/blog/assets/js/19.43fdc1b1.js"><link rel="prefetch" href="/public/blog/assets/js/20.c6e0b4b7.js"><link rel="prefetch" href="/public/blog/assets/js/21.81d73e54.js"><link rel="prefetch" href="/public/blog/assets/js/22.2da1489e.js"><link rel="prefetch" href="/public/blog/assets/js/23.98032a48.js"><link rel="prefetch" href="/public/blog/assets/js/24.bf1aeeb3.js"><link rel="prefetch" href="/public/blog/assets/js/25.ff0a5a9e.js"><link rel="prefetch" href="/public/blog/assets/js/26.9a69e70f.js"><link rel="prefetch" href="/public/blog/assets/js/27.78d71253.js"><link rel="prefetch" href="/public/blog/assets/js/28.05172e35.js"><link rel="prefetch" href="/public/blog/assets/js/29.836b5f2c.js"><link rel="prefetch" href="/public/blog/assets/js/30.7f2a0aa5.js"><link rel="prefetch" href="/public/blog/assets/js/31.16e7c775.js"><link rel="prefetch" href="/public/blog/assets/js/32.9d8aa648.js"><link rel="prefetch" href="/public/blog/assets/js/33.3ad73093.js"><link rel="prefetch" href="/public/blog/assets/js/34.a27e23cf.js"><link rel="prefetch" href="/public/blog/assets/js/35.34f0ba53.js"><link rel="prefetch" href="/public/blog/assets/js/36.993eb43f.js"><link rel="prefetch" href="/public/blog/assets/js/37.70ac44f6.js"><link rel="prefetch" href="/public/blog/assets/js/38.4b9e0ad1.js"><link rel="prefetch" href="/public/blog/assets/js/39.f8c33c98.js"><link rel="prefetch" href="/public/blog/assets/js/4.a6ed393e.js"><link rel="prefetch" href="/public/blog/assets/js/40.a2197e85.js"><link rel="prefetch" href="/public/blog/assets/js/41.467d6440.js"><link rel="prefetch" href="/public/blog/assets/js/42.ba8fc1fa.js"><link rel="prefetch" href="/public/blog/assets/js/44.9b55cec1.js"><link rel="prefetch" href="/public/blog/assets/js/45.fbd44db5.js"><link rel="prefetch" href="/public/blog/assets/js/46.cff257a8.js"><link rel="prefetch" href="/public/blog/assets/js/47.3cd816de.js"><link rel="prefetch" href="/public/blog/assets/js/48.fdd057cb.js"><link rel="prefetch" href="/public/blog/assets/js/49.e007afae.js"><link rel="prefetch" href="/public/blog/assets/js/5.868620b4.js"><link rel="prefetch" href="/public/blog/assets/js/50.05e06075.js"><link rel="prefetch" href="/public/blog/assets/js/51.28689d1c.js"><link rel="prefetch" href="/public/blog/assets/js/52.84b0ef5c.js"><link rel="prefetch" href="/public/blog/assets/js/53.586cad0a.js"><link rel="prefetch" href="/public/blog/assets/js/54.2b8a703d.js"><link rel="prefetch" href="/public/blog/assets/js/55.c466c411.js"><link rel="prefetch" href="/public/blog/assets/js/56.882ab9d2.js"><link rel="prefetch" href="/public/blog/assets/js/57.edaca7e3.js"><link rel="prefetch" href="/public/blog/assets/js/58.c7ce4964.js"><link rel="prefetch" href="/public/blog/assets/js/59.02f33b29.js"><link rel="prefetch" href="/public/blog/assets/js/6.8e0ec0a1.js"><link rel="prefetch" href="/public/blog/assets/js/60.3e43121d.js"><link rel="prefetch" href="/public/blog/assets/js/61.e73a45bf.js"><link rel="prefetch" href="/public/blog/assets/js/62.a1ea2161.js"><link rel="prefetch" href="/public/blog/assets/js/63.0a4a98df.js"><link rel="prefetch" href="/public/blog/assets/js/64.0422c733.js"><link rel="prefetch" href="/public/blog/assets/js/65.b26f077a.js"><link rel="prefetch" href="/public/blog/assets/js/7.287519a5.js"><link rel="prefetch" href="/public/blog/assets/js/8.5443f788.js"><link rel="prefetch" href="/public/blog/assets/js/9.ef0461e8.js">
    <link rel="stylesheet" href="/public/blog/assets/css/0.styles.3ad33863.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/public/blog/" class="home-link router-link-active"><!----> <span class="site-name">QLQ学习平台</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/public/blog/js/regexp.html" class="nav-link">javaScript</a></div><div class="nav-item"><a href="/public/blog/css/bfc.html" class="nav-link">css</a></div><div class="nav-item"><a href="/public/blog/webpack/base-config.html" class="nav-link">webpack</a></div><div class="nav-item"><a href="/public/blog/node/buffer.html" class="nav-link">node</a></div><div class="nav-item"><a href="/public/blog/fragment/angular.html" class="nav-link">js框架</a></div><div class="nav-item"><a href="/public/blog/pwa/PWA.html" class="nav-link">pwa</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/public/blog/js/regexp.html" class="nav-link">javaScript</a></div><div class="nav-item"><a href="/public/blog/css/bfc.html" class="nav-link">css</a></div><div class="nav-item"><a href="/public/blog/webpack/base-config.html" class="nav-link">webpack</a></div><div class="nav-item"><a href="/public/blog/node/buffer.html" class="nav-link">node</a></div><div class="nav-item"><a href="/public/blog/fragment/angular.html" class="nav-link">js框架</a></div><div class="nav-item"><a href="/public/blog/pwa/PWA.html" class="nav-link">pwa</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>node</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/public/blog/node/buffer.html" class="sidebar-link">Buffer</a></li><li><a href="/public/blog/node/stream.html" class="sidebar-link">Stream</a></li><li><a href="/public/blog/node/nodemon.html" class="sidebar-link">nodemon：高效的nodejs开发环境</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="policies"><a href="#policies" class="header-anchor">#</a> Policies</h1> <blockquote><p>Stability: 1 - Experimental</p></blockquote> <p>Node.js contains experimental support for creating policies on loading code.</p> <p>Policies are a security feature intended to allow guarantees
about what code Node.js is able to load. The use of policies assumes
safe practices for the policy files such as ensuring that policy
files cannot be overwritten by the Node.js application by using
file permissions.</p> <p>A best practice would be to ensure that the policy manifest is read only for
the running Node.js application, and that the file cannot be changed
by the running Node.js application in any way. A typical setup would be to
create the policy file as a different user id than the one running Node.js
and granting read permissions to the user id running Node.js.</p> <h2 id="enabling"><a href="#enabling" class="header-anchor">#</a> Enabling</h2> <p>The <code>--experimental-policy</code> flag can be used to enable features for policies
when loading modules.</p> <p>Once this has been set, all modules must conform to a policy manifest file
passed to the flag:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>node --experimental-policy<span class="token operator">=</span>policy.json app.js
</code></pre></div><p>The policy manifest will be used to enforce constraints on code loaded by
Node.js.</p> <p>To mitigate tampering with policy files on disk, an integrity for
the policy file itself may be provided via <code>--policy-integrity</code>.
This allows running <code>node</code> and asserting the policy file contents
even if the file is changed on disk.</p> <div class="language-sh extra-class"><pre class="language-sh"><code>node --experimental-policy<span class="token operator">=</span>policy.json --policy-integrity<span class="token operator">=</span><span class="token string">&quot;sha384-SggXRQHwCG8g+DktYYzxkXRIkTiEYWBHqev0xnpCxYlqMBufKZHAHQM3/boDaI/0&quot;</span> app.js
</code></pre></div><h2 id="features"><a href="#features" class="header-anchor">#</a> Features</h2> <h3 id="error-behavior"><a href="#error-behavior" class="header-anchor">#</a> Error Behavior</h3> <p>When a policy check fails, Node.js by default will throw an error.
It is possible to change the error behavior to one of a few possibilities
by defining an &quot;onerror&quot; field in a policy manifest. The following values are
available to change the behavior:</p> <ul><li><code>&quot;exit&quot;</code>: will exit the process immediately.
No cleanup code will be allowed to run.</li> <li><code>&quot;log&quot;</code>: will log the error at the site of the failure.</li> <li><code>&quot;throw&quot;</code>: will throw a JS error at the site of the failure. This is the
default.</li></ul> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;onerror&quot;</span><span class="token operator">:</span> <span class="token string">&quot;log&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;resources&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;./app/checked.js&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;integrity&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sha384-SggXRQHwCG8g+DktYYzxkXRIkTiEYWBHqev0xnpCxYlqMBufKZHAHQM3/boDaI/0&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="integrity-checks"><a href="#integrity-checks" class="header-anchor">#</a> Integrity Checks</h3> <p>Policy files must use integrity checks with Subresource Integrity strings
compatible with the browser
<a href="https://www.w3.org/TR/SRI/#the-integrity-attribute" target="_blank" rel="noopener noreferrer">integrity attribute<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>
associated with absolute URLs.</p> <p>When using <code>require()</code> all resources involved in loading are checked for
integrity if a policy manifest has been specified. If a resource does not match
the integrity listed in the manifest, an error will be thrown.</p> <p>An example policy file that would allow loading a file <code>checked.js</code>:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;resources&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;./app/checked.js&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;integrity&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sha384-SggXRQHwCG8g+DktYYzxkXRIkTiEYWBHqev0xnpCxYlqMBufKZHAHQM3/boDaI/0&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Each resource listed in the policy manifest can be of one the following
formats to determine its location:</p> <ol><li>A <a href="https://url.spec.whatwg.org/#relative-url-with-fragment-string" target="_blank" rel="noopener noreferrer">relative url string<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> to a resource from the manifest such as <code>./resource.js</code>, <code>../resource.js</code>, or <code>/resource.js</code>.</li> <li>A complete url string to a resource such as <code>file:///resource.js</code>.</li></ol> <p>When loading resources the entire URL must match including search parameters
and hash fragment. <code>./a.js?b</code> will not be used when attempting to load
<code>./a.js</code> and vice versa.</p> <p>To generate integrity strings, a script such as
<code>printf &quot;sha384-$(cat checked.js | openssl dgst -sha384 -binary | base64)&quot;</code>
can be used.</p> <p>Integrity can be specified as the boolean value <code>true</code> to accept any
body for the resource which can be useful for local development. It is not
recommended in production since it would allow unexpected alteration of
resources to be considered valid.</p> <h3 id="dependency-redirection"><a href="#dependency-redirection" class="header-anchor">#</a> Dependency Redirection</h3> <p>An application may need to ship patched versions of modules or to prevent
modules from allowing all modules access to all other modules. Redirection
can be used by intercepting attempts to load the modules wishing to be
replaced.</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;builtins&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;resources&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;./app/checked.js&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;fs&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token property">&quot;os&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./app/node_modules/alt-os&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The dependencies are keyed by the requested string specifier and have values
of either <code>true</code> or a string pointing to a module that will be resolved.</p> <p>The specifier string does not perform any searching and must match exactly
what is provided to the <code>require()</code>. Therefore, multiple specifiers may be
needed in the policy if <code>require()</code> uses multiple different strings to point
to the same module (such as excluding the extension).</p> <p>If the value of the redirection is <code>true</code> the default searching algorithms will
be used to find the module.</p> <p>If the value of the redirection is a string, it will be resolved relative to
the manifest and then immediately be used without searching.</p> <p>Any specifier string that is <code>require()</code>ed and not listed in the dependencies
will result in an error according to the policy.</p> <p>Redirection will not prevent access to APIs through means such as direct access
to <code>require.cache</code> and/or through <code>module.constructor</code> which allow access to
loading modules. Policy redirection only affect specifiers to <code>require()</code>.
Other means such as to prevent undesired access to APIs through variables are
necessary to lock down that path of loading modules.</p> <p>A boolean value of <code>true</code> for the dependencies map can be specified to allow a
module to load any specifier without redirection. This can be useful for local
development and may have some valid usage in production, but should be used
only with care after auditing a module to ensure its behavior is valid.</p> <h4 id="example-patched-dependency"><a href="#example-patched-dependency" class="header-anchor">#</a> Example: Patched Dependency</h4> <p>Since a dependency can be redirected, you can provide attenuated or modified
forms of dependencies as fits your application. For example, you could log
data about timing of function durations by wrapping the original:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> original <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fn'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span><span class="token punctuation">.</span>target <span class="token operator">?</span>
      Reflect<span class="token punctuation">.</span><span class="token function">construct</span><span class="token punctuation">(</span>original<span class="token punctuation">,</span> args<span class="token punctuation">)</span> <span class="token punctuation">:</span>
      <span class="token function">Reflect</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>original<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/public/blog/assets/js/app.e4ea57ce.js" defer></script><script src="/public/blog/assets/js/2.d1dd4e4d.js" defer></script><script src="/public/blog/assets/js/43.b9d80aa8.js" defer></script><script src="/public/blog/assets/js/3.1f730cd9.js" defer></script>
  </body>
</html>
